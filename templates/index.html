<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woldebots | Financial Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #030509;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --glass-bg: rgba(15, 23, 42, 0.5);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --card-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
            --accent-glow: rgba(59, 130, 246, 0.15);
        }

        * {
            box-sizing: border-box;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background:
                linear-gradient(to bottom, rgba(7, 9, 14, 0.95), rgba(7, 9, 14, 0.98)),
                url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0V0zm1 1h38v38H1V1z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* Cyber Elements */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(59, 130, 246, 0.05) 50%, rgba(0, 0, 0, 0) 100%);
            opacity: 0.1;
            position: fixed;
            bottom: 100%;
            animation: scanline 8s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                bottom: 100%;
            }

            100% {
                bottom: -100px;
            }
        }

        /* W Logo Styling */
        .brand-container {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            margin-bottom: 4rem;
            margin-top: 4rem;
            animation: fadeInDown 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .logo-w {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 32px;
            color: white;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .logo-w::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 9px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            z-index: -1;
            opacity: 0.5;
            filter: blur(8px);
        }

        .brand-name {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, #fff 60%, rgba(255, 255, 255, 0.4));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            /* Sharper corners for intelligence feel */
            padding: 3rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30px;
            height: 2px;
            background: var(--accent-primary);
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 30px;
            background: var(--accent-primary);
        }

        /* Professional Tabs */
        .tabs-nav {
            display: flex;
            background: rgba(15, 23, 42, 0.8);
            padding: 0.3rem;
            border-radius: 6px;
            margin-bottom: 3rem;
            border: 1px solid var(--glass-border);
            gap: 0.3rem;
            gap: 0.3rem;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-trigger {
            flex: 1;
            padding: 0.9rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }

        .tab-trigger.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .tab-trigger:hover:not(.active) {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
        }

        /* Inputs & Buttons */
        textarea {
            width: 100%;
            height: 160px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1.2rem;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            margin-bottom: 1.5rem;
        }

        textarea:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
            color: white;
            padding: 1.1rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Management */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-weight: 700;
            font-size: 1.4rem;
            margin: 0;
        }

        .badge-count {
            background: var(--accent-primary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 800;
        }

        /* Table Aesthetics */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.8rem;
        }

        th {
            text-align: left;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        td {
            padding: 1.2rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid var(--glass-border);
            border-bottom: 1px solid var(--glass-border);
        }

        td:first-child {
            border-left: 1px solid var(--glass-border);
            border-radius: 12px 0 0 12px;
        }

        td:last-child {
            border-right: 1px solid var(--glass-border);
            border-radius: 0 12px 12px 0;
        }

        .ticker-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: #fff;
        }

        .spread-val {
            font-family: 'Outfit', sans-serif;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-weight: 700;
        }

        .tv-btn {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .tv-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        /* New Badge */
        .new-indicator {
            background: var(--success);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 900;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Indicator */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-dot.processing {
            background: var(--accent-primary);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.4;
            }
        }

        /* Copy Button */
        .btn-outline {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Mission Control Inputs */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .range-controls-grid,
        .imbalance-controls-grid,
        .dividend-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1.5rem;
        }

        .control-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.8rem;
        }

        .control-item input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 0.8rem;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
        }

        .master-list-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Cyber Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 2px;
        }

        input:checked+.slider {
            background-color: var(--accent-primary);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
            background-color: white;
        }

        /* Progress Area */
        .progress-area {
            background: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .progress-track {
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
            transition: width 0.4s ease;
        }

        /* Signature Animation */
        .signature {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.65rem;
            color: var(--text-secondary);
            opacity: 0.2;
            letter-spacing: 3px;
            pointer-events: none;
            text-transform: uppercase;
            font-weight: 900;
            animation: ghost-flicker 10s infinite;
        }

        @keyframes ghost-flicker {

            0%,
            100% {
                opacity: 0.2;
            }

            45% {
                opacity: 0.2;
            }

            50% {
                opacity: 0.05;
            }

            55% {
                opacity: 0.25;
            }

            60% {
                opacity: 0.2;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dividend Recovery Styles */
        .div-recovered {
            color: var(--success);
            font-weight: 700;
        }

        .div-not-recovered {
            color: var(--error);
            font-weight: 700;
        }

        .div-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .control-item select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 0.8rem;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>

<div class="scanline"></div>
<div class="container">
    <header class="brand-container">
        <div class="logo-w">W</div>
        <h1 class="brand-name">Woldebots</h1>
    </header>

    <nav class="tabs-nav">
        <button class="tab-trigger active" onclick="switchTab('custom', this)" data-tab="custom">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                </path>
            </svg>
            Range Intelligence
        </button>
        <button class="tab-trigger" onclick="switchTab('imbalance', this)" data-tab="imbalance">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Imbalance AI
        </button>
        <button class="tab-trigger" onclick="switchTab('dividend', this)" data-tab="dividend">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
            </svg>
            Dividend Recovery
        </button>
    </nav>

    <!-- Dynamic Content Area -->
    <main id="mainContainer">

        <!-- Range AI Section -->
        <section id="customSection" class="glass-card" style="animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Range AI Control
                        Panel</h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="rangeMasterList">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size:0.85rem; font-weight:700; color:var(--text-secondary)">Analyze Master
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="rangeCefList">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size:0.85rem; font-weight:700; color:var(--text-secondary)">Analyze CEF
                                List</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Target Nodes (Separated by Newline)</label>
                    <textarea id="tickers" placeholder="AAPL&#10;TSLA&#10;NVDA..."></textarea>
                </div>
                <div class="range-controls-grid">
                    <div class="control-item">
                        <label>Analysis Period (Days)</label>
                        <input type="number" id="rangeDays" value="90" min="1" max="730">
                    </div>
                    <div class="control-item">
                        <label>Max Point Range</label>
                        <input type="number" id="rangePoints" value="1.0" step="0.1" min="0">
                    </div>
                    <div class="control-item">
                        <label>Max Percentage Range (%)</label>
                        <input type="number" id="rangePercent" value="5.0" step="0.1" min="0">
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeBtn" onclick="startRangeAnalysis()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Identify Range Stability
            </button>

            <div id="progressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="progressText">Initializing Range AI...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>



        <!-- Imbalance AI Section -->
        <section id="imbalanceSection" class="glass-card" style="display:none; animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Imbalance AI Terminal
                    </h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="imbMasterList">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size:0.85rem; font-weight:700; color:var(--text-secondary)">Analyze Master
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="imbCefList">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size:0.85rem; font-weight:700; color:var(--text-secondary)">Analyze CEF
                                List</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Target Nodes</label>
                    <textarea id="imbalanceTickers" placeholder="AAPL&#10;MSFT..."></textarea>
                </div>
                <div class="imbalance-controls-grid">
                    <div class="control-item">
                        <label>Search Period (Days)</label>
                        <input type="number" id="imbDays" value="30" min="1" max="180">
                    </div>
                    <div class="control-item">
                        <label>Min Occurrences</label>
                        <input type="number" id="imbMinCount" value="6" min="1">
                    </div>
                    <div class="control-item">
                        <label>Max Wick Ratio</label>
                        <input type="number" id="imbMaxWick" value="0.12" step="0.01" min="0">
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeImbalanceBtn" onclick="startImbalanceAnalysis()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Identify Imbalance Patterns
            </button>

            <div id="imbProgressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="imbProgressText">Scanning Patterns...</span>
                    <span id="imbProgressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="imbProgressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>

        <!-- Dividend Recovery Section -->
        <section id="dividendSection" class="glass-card" style="display:none; animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Dividend Recovery
                        Terminal</h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="divMasterList">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size:0.85rem; font-weight:700; color:var(--text-secondary)">Analyze Master
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="divCefList">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size:0.85rem; font-weight:700; color:var(--text-secondary)">Analyze CEF
                                List</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Target Nodes</label>
                    <textarea id="dividendTickers" placeholder="BAC-Q&#10;PCG-G..."></textarea>
                </div>
                <div class="dividend-controls-grid">
                    <div class="control-item">
                        <label>Dividend Lookback</label>
                        <select id="divLookback">
                            <option value="3">Last 3 Dividends</option>
                            <option value="5">Last 5 Dividends</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>Recovery Window (Days)</label>
                        <input type="number" id="divRecWindow" value="5" min="1" max="30">
                    </div>
                    <div class="control-item">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <label>Target Recovery %</label>
                            <div style="display:flex; align-items:center; gap:5px; margin-bottom:0.8rem;">
                                <input type="checkbox" id="divStrictFilter"
                                    style="width:14px; height:14px; cursor:pointer;">
                                <span
                                    style="font-size:0.65rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">Strict
                                    Filter</span>
                            </div>
                        </div>
                        <input type="number" id="divTargetPct" value="90" min="1" max="100">
                    </div>
                    <div class="control-item">
                        <label>Sort By</label>
                        <select id="divSort">
                            <option value="fastest">Fastest Recovery</option>
                            <option value="slowest">Slowest Recovery</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <label>Upcoming Div Filter</label>
                            <div style="display:flex; align-items:center; gap:5px; margin-bottom:0.8rem;">
                                <input type="checkbox" id="divUpcomingFilter"
                                    style="width:14px; height:14px; cursor:pointer;">
                                <span
                                    style="font-size:0.65rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase;">Apply</span>
                            </div>
                        </div>
                        <input type="number" id="divUpcomingDays" value="14" min="1" max="14">
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeDividendBtn" onclick="startDividendAnalysis()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                Analyze Dividend Recovery
            </button>

            <div id="divProgressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="divProgressText">Analyzing Dividends...</span>
                    <span id="divProgressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="divProgressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>

        <!-- Range AI Results Area -->
        <section id="customResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Range Stability Output</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        High-probability stability nodes identified by Range AI filters.
                    </p>
                </div>
                <div>
                    <span class="badge" id="rangeMatchCount">0 Symbols Found</span>
                    <button class="tv-btn" onclick="copyToClipboard('custom')">Copy Symbols</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="customResultsTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Range (Pts)</th>
                            <th>Min / Max</th>
                            <th>Current</th>
                            <th>% Range</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Smart Watchlist results removed -->

        <!-- Imbalance AI Results Area -->
        <section id="imbalanceResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Imbalance Pattern Output</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        Directional liquidity imbalances detected in recent sessions.
                    </p>
                </div>
                <div>
                    <span id="imbMatchCount" class="badge">0 Symbols Found</span>
                    <button class="tv-btn" onclick="copyToClipboard('imbalance')">Copy Symbols</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="imbalanceResultsTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Pattern</th>
                            <th>Match Count</th>
                            <th>Avg Diff</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Dividend Recovery Results Area -->
        <section id="dividendResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Dividend Recovery Analysis</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        Recovery timeline tracking for post-dividend price movements.
                    </p>
                </div>
                <div>
                    <span id="divMatchCount" class="badge">0 Symbols Analyzed</span>
                    <button class="tv-btn" onclick="copyToClipboard('dividend')">Copy Symbols</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="dividendResultsTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Div #1</th>
                            <th>Div #2</th>
                            <th>Div #3</th>
                            <th>Current Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- No Results Message -->
        <div id="noResults"
            style="display:none; text-align:center; padding:3rem 0; color:var(--text-secondary); font-style:italic;">
            No datasets matched the defined intelligence parameters.
        </div>
    </main>
</div>

<script>
    let jobId = null;
    let pollInterval = null;

    // Track unique polling cycles to prevent zombies
    let pollTimers = {
        imbalance: null
    };

    let dataStore = {
        custom: [], // This will now store Range AI results
        imbalance: []
    };

    let currentTab = 'custom';

    function switchTab(tab, el) {
        if (tab === currentTab) return;
        currentTab = tab;
        console.log("Switching to tab:", tab);

        // UI Visual Update
        document.querySelectorAll('.tab-trigger').forEach(b => b.classList.remove('active'));
        if (el) {
            el.classList.add('active');
        } else {
            const btns = Array.from(document.querySelectorAll('.tab-trigger'));
            const target = btns.find(b => b.getAttribute('data-tab') === tab);
            if (target) target.classList.add('active');
        }

        // Hide sections and result cards
        ['custom', 'imbalance', 'dividend'].forEach(t => {
            document.getElementById(`${t}Section`).style.display = 'none';
            document.getElementById(`${t}ResultsCard`).style.display = 'none';
        });
        document.getElementById('noResults').style.display = 'none';

        if (tab === 'custom') {
            document.getElementById('customSection').style.display = 'block';
            if (dataStore.custom.length > 0) {
                renderResults('custom', dataStore.custom);
            }
        } else if (tab === 'imbalance') {
            document.getElementById('imbalanceSection').style.display = 'block';
            if (dataStore.imbalanceResults && dataStore.imbalanceResults.length > 0) {
                renderImbalanceResults(dataStore.imbalanceResults);
            }
        } else if (tab === 'dividend') {
            document.getElementById('dividendSection').style.display = 'block';
            if (dataStore.dividend && dataStore.dividend.length > 0) {
                renderDividendResults(dataStore.dividend);
            }
        }
    }

    async function stopImbalance() {
        await fetch('/stop_imbalance', { method: 'POST' });
    }

    async function startRangeAnalysis() {
        const masterToggle = document.getElementById('rangeMasterList');
        const cefToggle = document.getElementById('rangeCefList');
        let tickers = [];

        if (cefToggle.checked) {
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerText = "Loading Master List...";
            try {
                const tRes = await fetch('/get_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('tickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('analyzeBtn').innerText = "Analyzing Range...";
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('noResults').style.display = 'none';

        // Clear data store
        dataStore.custom = [];

        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 3;

        updateProgress(0, `Initializing Range AI for ${total} tickers...`);

        const days = document.getElementById('rangeDays').value;
        const maxPoints = document.getElementById('rangePoints').value;
        const maxPercent = document.getElementById('rangePercent').value;

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                // Accuracy Tuning: Batch fetch with retry
                let data = null;
                let retries = 2;
                while (retries >= 0) {
                    try {
                        const formData = new FormData();
                        formData.append('tickers', batchStr);
                        formData.append('days', days);
                        formData.append('max_points', maxPoints);
                        formData.append('max_percent', maxPercent);

                        updateProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                        const res = await fetch('/analyze_range_batch', { method: 'POST', body: formData });
                        data = await res.json();
                        if (data.error) throw new Error(data.error);
                        break; // Success
                    } catch (err) {
                        console.warn(`Retry ${2 - retries} for batch ${batchStr}: ${err.message}`);
                        retries--;
                        if (retries < 0) throw err;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (data.results && data.results.length > 0) {
                    dataStore.custom = [...(dataStore.custom || []), ...data.results];
                    renderResults('custom', dataStore.custom);
                }

                completed += batch.length;
                updateProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);

                await new Promise(r => setTimeout(r, 400));
            }

            updateProgress(100, "Range Analysis Complete");

            if (!dataStore.custom || dataStore.custom.length === 0) {
                document.getElementById('noResults').style.display = 'block';
            }

        } catch (e) {
            console.error(e);
            alert("Scan Error: " + e.message);
        } finally {
            resetUI();
        }
    }



    function updateProgress(percent, text) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressPercent').innerText = percent + '%';
        document.getElementById('progressText').innerText = text;
    }

    async function startImbalanceAnalysis() {
        const masterToggle = document.getElementById('imbMasterList');
        const cefToggle = document.getElementById('imbCefList');
        let tickers = [];

        if (cefToggle.checked) {
            document.getElementById('analyzeImbalanceBtn').disabled = true;
            document.getElementById('analyzeImbalanceBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeImbalanceBtn').disabled = true;
            document.getElementById('analyzeImbalanceBtn').innerText = "Loading Master List...";
            try {
                const tRes = await fetch('/get_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('imbalanceTickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeImbalanceBtn').disabled = true;
        document.getElementById('analyzeImbalanceBtn').innerText = "Analyzing Patterns...";
        document.getElementById('imbProgressContainer').style.display = 'block';
        document.getElementById('imbalanceResultsCard').style.display = 'none';
        document.querySelector('#imbalanceResultsTable tbody').innerHTML = '';
        document.getElementById('noResults').style.display = 'none';

        // Clear data store
        dataStore.imbalanceResults = [];

        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 3;

        updateImbProgress(0, `Initializing scan for ${total} tickers...`);

        // NEW PARAMS
        const days = document.getElementById('imbDays').value;
        const minCount = document.getElementById('imbMinCount').value;
        const maxWick = document.getElementById('imbMaxWick').value;

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                // Accuracy Tuning: Batch fetch with retry
                let data = null;
                let retries = 2;
                while (retries >= 0) {
                    try {
                        const formData = new FormData();
                        formData.append('tickers', batchStr);
                        formData.append('days', days);
                        formData.append('min_count', minCount);
                        formData.append('max_wick', maxWick);

                        updateImbProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                        const res = await fetch('/analyze_imbalance_batch', { method: 'POST', body: formData });
                        data = await res.json();
                        if (data.error) throw new Error(data.error);
                        break; // Success
                    } catch (err) {
                        console.warn(`Retry ${2 - retries} for batch ${batchStr}: ${err.message}`);
                        retries--;
                        if (retries < 0) throw err;
                        await new Promise(r => setTimeout(r, 1000)); // Wait before retry
                    }
                }

                if (data.results && data.results.length > 0) {
                    dataStore.imbalanceResults = [...(dataStore.imbalanceResults || []), ...data.results];
                    renderImbalanceResults(dataStore.imbalanceResults);
                }

                completed += batch.length;
                updateImbProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);

                // Accuracy Tuning: Increased delay between batches
                // This prevents heavy load and allows Vercel workers some breathing room
                await new Promise(r => setTimeout(r, 400));
            }

            updateImbProgress(100, "Scan Complete");

            if (!dataStore.imbalanceResults || dataStore.imbalanceResults.length === 0) {
                renderImbalanceResults([]);
            }

        } catch (e) {
            console.error(e);
            alert("Scan Error: " + e.message);
        } finally {
            resetUI();
        }
    }

    // Removed imbPollStatus as it is no longer needed

    function updateImbProgress(percent, text) {
        document.getElementById('imbProgressFill').style.width = percent + '%';
        document.getElementById('imbProgressPercent').innerText = percent + '%';
        document.getElementById('imbProgressText').innerText = text;
    }

    function renderImbalanceResults(results) {
        if (!results || results.length === 0) {
            document.getElementById('imbalanceResultsCard').style.display = 'none';

            // Show strict "No Results" message
            const noRes = document.getElementById('noResults');
            noRes.style.display = 'block';
            noRes.innerHTML = `
                    <div style="text-align:center; padding:2rem;">
                        <span style="font-size:2rem;">üîç</span>
                        <h3>No Matches Found</h3>
                        <p style="color:var(--text-secondary)">
                            No tickers matched your strict criteria (Min Count, Max Wick).<br>
                            Try reducing the <b>Min Occurrences</b> or increasing <b>Max Wick</b>.
                        </p>
                    </div>
                `;
            return;
        }

        document.getElementById('imbalanceResultsCard').style.display = 'block';
        document.getElementById('imbMatchCount').innerText = `${results.length} Matches`;

        const tbody = document.querySelector('#imbalanceResultsTable tbody');
        tbody.innerHTML = '';

        results.sort((a, b) => a.ticker.localeCompare(b.ticker)).forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            // Style badge based on color
            const color = item.target_color || 'Green';
            const badgerStyle = color === 'Green' ?
                'background:rgba(16,185,129,0.1); color:var(--success)' :
                'background:rgba(239,68,68,0.1); color:var(--error)';

            const displayDays = item.days || item.total_days || 30;
            const displayWick = item.max_wick || 0.12;
            const detailStr = `(LAST ${displayDays} DAYS | WICK <= ${displayWick})`;

            tr.innerHTML = `
                    <td>
                        <div style="display:flex; align-items:center;">
                            <span class="ticker-name">${item.ticker}</span>
                            ${item.is_new ? '<span class="new-indicator">New</span>' : ''}
                        </div>
                        <div style="font-size:0.75rem; color:var(--text-secondary); margin-top:4px;">
                            ${detailStr}
                        </div>
                    </td>
                    <td><span class="spread-val" style="${badgerStyle}">${color} Candle</span></td>
                    <td>${item.match_count}</td>
                    <td>${item.avg_diff}</td>
                    <td><a href="${tvUrl}" target="_blank" class="tv-btn">View Nodes</a></td>
                `;
            tbody.appendChild(tr);
        });

        document.getElementById('noResults').style.display = 'none';
    }

    function copyImbalanceTickers() {
        if (!dataStore.imbalanceResults) return;
        const tickers = dataStore.imbalanceResults.map(r => r.ticker).join(',');
        navigator.clipboard.writeText(tickers).then(() => {
            const btn = event.target;
            const oldText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = oldText, 2000);
        });
    }
    function renderResults(type, results) {
        if (!results) return;

        // Persistent storage check before UI filtering
        if (results && results.length > 0) {
            dataStore[type] = results;
        }

        // Update match count badges
        const countId = type === 'imbalance' ? 'imbMatchCount' : (type === 'custom' ? 'rangeMatchCount' : null);
        if (countId) {
            const countEl = document.getElementById(countId);
            if (countEl) countEl.innerText = `${results.length} Symbols Found`;
        }

        // ONLY update DOM if it's the current tab
        if (currentTab !== type) return;

        // CRITICAL: Hide ALL result cards before showing the one we want
        document.getElementById('customResultsCard').style.display = 'none';
        document.getElementById('imbalanceResultsCard').style.display = 'none';

        const card = document.getElementById(`${type}ResultsCard`);
        const tbody = document.querySelector(`#${type}ResultsTable tbody`);
        const noRes = document.getElementById('noResults');

        if (results.length === 0) {
            card.style.display = 'none';
            if (currentTab === type) noRes.style.display = 'block';
            return;
        }

        card.style.display = 'block';
        noRes.style.display = 'none';
        tbody.innerHTML = '';

        results.sort((a, b) => a.ticker.localeCompare(b.ticker)).forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            if (type === 'custom') {
                tr.innerHTML = `
                        <td>
                            <div style="display:flex; align-items:center;">
                                <span class="ticker-name">${item.ticker}</span>
                            </div>
                            <div style="font-size:0.75rem; color:var(--text-secondary); margin-top:4px;">
                                (LAST ${item.days} DAYS)
                            </div>
                        </td>
                        <td><span class="spread-val">${item.point_range} pts</span></td>
                        <td>$${item.min} - $${item.max}</td>
                        <td>$${item.current}</td>
                        <td><span style="color:var(--accent-secondary); font-weight:600;">${item.percent_range}%</span></td>
                        <td><a href="${tvUrl}" target="_blank" class="tv-btn">View Chart</a></td>
                    `;
            }
            tbody.appendChild(tr);
        });
    }

    function copyToClipboard(type) {
        let results = [];
        if (type === 'imbalance') {
            results = dataStore.imbalanceResults || [];
        } else {
            results = dataStore[type];
        }

        if (!results || results.length === 0) return;
        const text = results.map(r => r.ticker).sort().join(', ');
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target;
            const oldText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = oldText, 2000);
        });
    }

    function resetUI() {
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('analyzeBtn').innerText = "Run Intelligence Report";
        document.getElementById('analyzeImbalanceBtn').disabled = false;
        document.getElementById('analyzeImbalanceBtn').innerText = "Identify Imbalance Patterns";
        document.getElementById('analyzeDividendBtn').disabled = false;
        document.getElementById('analyzeDividendBtn').innerText = "Analyze Dividend Recovery";
    }

    // --- Dividend Recovery Logic ---

    async function startDividendAnalysis() {
        const masterToggle = document.getElementById('divMasterList');
        const cefToggle = document.getElementById('divCefList');
        let tickers = [];

        if (cefToggle.checked) {
            document.getElementById('analyzeDividendBtn').disabled = true;
            document.getElementById('analyzeDividendBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeDividendBtn').disabled = true;
            document.getElementById('analyzeDividendBtn').innerText = "Loading Master List...";
            try {
                const tRes = await fetch('/get_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('dividendTickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeDividendBtn').disabled = true;
        document.getElementById('analyzeDividendBtn').innerText = "Analyzing Dividends...";
        document.getElementById('divProgressContainer').style.display = 'block';
        document.getElementById('dividendResultsCard').style.display = 'none';
        document.getElementById('noResults').style.display = 'none';

        // Clear data store
        dataStore.dividend = [];

        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 4; // Slightly larger batch for dividend checks

        updateDivProgress(0, `Initializing analysis for ${total} tickers...`);

        const lookback = document.getElementById('divLookback').value;
        const recWindow = document.getElementById('divRecWindow').value;

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                // Retry logic
                let data = null;
                let retries = 2;
                while (retries >= 0) {
                    try {
                        const formData = new FormData();
                        formData.append('tickers', batchStr);
                        formData.append('lookback', lookback);
                        formData.append('recovery_window', recWindow);

                        updateDivProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                        const res = await fetch('/analyze_dividend_recovery', { method: 'POST', body: formData });
                        data = await res.json();
                        if (data.error) throw new Error(data.error);
                        break;
                    } catch (err) {
                        console.warn(`Retry ${2 - retries} for batch ${batchStr}: ${err.message}`);
                        retries--;
                        if (retries < 0) throw err;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (data.results && data.results.length > 0) {
                    dataStore.dividend = [...(dataStore.dividend || []), ...data.results];
                    renderDividendResults(dataStore.dividend);
                }

                completed += batch.length;
                updateDivProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);

                await new Promise(r => setTimeout(r, 300));
            }

            updateDivProgress(100, "Analysis Complete");

            if (!dataStore.dividend || dataStore.dividend.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('dividendResultsCard').style.display = 'none';
            }

        } catch (e) {
            console.error(e);
            alert("Analysis Error: " + e.message);
        } finally {
            resetUI();
        }
    }

    function updateDivProgress(percent, text) {
        document.getElementById('divProgressFill').style.width = percent + '%';
        document.getElementById('divProgressPercent').innerText = percent + '%';
        document.getElementById('divProgressText').innerText = text;
    }

    function renderDividendResults(results) {
        if (!results || results.length === 0) return;

        document.getElementById('dividendResultsCard').style.display = 'block';
        document.getElementById('divMatchCount').innerText = `${results.length} Analyzed`;

        const table = document.getElementById('dividendResultsTable');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');

        // Dynamic Headers based on lookback (max count of dividends found)
        let maxDivs = 0;
        results.forEach(r => {
            if (r.dividends && r.dividends.length > maxDivs) maxDivs = r.dividends.length;
        });

        // Rebuild Headers
        thead.innerHTML = '<th>Ticker</th>';
        for (let i = 0; i < maxDivs; i++) {
            thead.innerHTML += `<th>Div #${i + 1}</th>`;
        }
        thead.innerHTML += '<th>Stats</th><th>Action</th>';

        tbody.innerHTML = '';

        // Filter and Sort Logic
        const sortType = document.getElementById('divSort').value;
        const targetPct = parseFloat(document.getElementById('divTargetPct').value) || 90;
        const recWindow = parseInt(document.getElementById('divRecWindow').value) || 5;

        // Helper to calculate score for sorting
        results.forEach(item => {
            let totalRecDays = 0;
            let totalRecPct = 0;
            let recCount = 0;

            if (item.dividends && item.dividends.length > 0) {
                item.dividends.forEach(div => {
                    if (div.recovered) {
                        totalRecDays += div.recovery_days;
                    } else {
                        totalRecDays += 999;
                    }
                    // For score: Prioritize window_recv_pct
                    totalRecPct += (div.window_recv_pct || 0);
                });
                item.avg_rec_pct = totalRecPct / item.dividends.length;
                item.avg_rec_days = totalRecDays / item.dividends.length;
            } else {
                item.avg_rec_pct = -1;
                item.avg_rec_days = 9999;
            }

            // Score Logic: High Pct is best. Low Days is tiebreaker.
            // Let's make a combined score where Higher is Better
            // Score = (AvgPct * 100) - AvgDays
            item.rec_score = (item.avg_rec_pct * 1000) - item.avg_rec_days;
        });

        // SORTING
        if (sortType === 'fastest') {
            results.sort((a, b) => {
                // Primary: Pct (Descending) - Higher is better
                if (Math.abs(a.avg_rec_pct - b.avg_rec_pct) > 0.1) {
                    return b.avg_rec_pct - a.avg_rec_pct;
                }
                // Secondary: Days (Ascending) - Lower is better
                return a.avg_rec_days - b.avg_rec_days;
            });
        } else if (sortType === 'slowest') {
            results.sort((a, b) => {
                // Primary: Pct (Ascending) - Lower is worse (slowest)
                if (Math.abs(a.avg_rec_pct - b.avg_rec_pct) > 0.1) {
                    return a.avg_rec_pct - b.avg_rec_pct;
                }
                // Secondary: Days (Descending) - Higher is slower
                return b.avg_rec_days - a.avg_rec_days;
            });
        }

        // STRICT FILTERING
        const strictFilter = document.getElementById('divStrictFilter').checked;
        let filteredResults = results;
        if (strictFilter) {
            filteredResults = results.filter(item => {
                let metCriteriaCount = 0;
                if (item.dividends && item.dividends.length > 0) {
                    item.dividends.forEach(div => {
                        if (div.window_recv_pct >= targetPct) metCriteriaCount++;
                    });
                    return metCriteriaCount === item.dividends.length;
                }
                return false;
            });
        }

        // UPCOMING DIV FILTERING
        const upcomingFilter = document.getElementById('divUpcomingFilter').checked;
        const upcomingDaysLimit = parseInt(document.getElementById('divUpcomingDays').value) || 14;

        if (upcomingFilter) {
            filteredResults = filteredResults.filter(item => {
                // Must be between 1 and X days
                return item.next_div_days !== null && item.next_div_days >= 1 && item.next_div_days <= upcomingDaysLimit;
            });
        }

        filteredResults.forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            let tds = `<td><span class="ticker-name">${item.ticker}</span>`;

            // Check if it meets the specific "X% in Y days" criteria for ALL analyzed dividends?
            // User request: "son 3 divinin ilk 5 g√ºn√ºnde %90'ƒ±nƒ± recoverlayan kaƒüƒ±tlarƒ± ayrƒ±ca g√∂ster"
            // Let's count how many met the criteria
            let metCriteriaCount = 0;
            if (item.dividends) {
                item.dividends.forEach(div => {
                    if (div.window_recv_pct >= targetPct) metCriteriaCount++;
                });
            }

            // Highlight if ALL met criteria (or maybe simplified to 'all')?
            // Let's use a badge if it performed well in the window
            // Strict check: Must have ACTUAL dividends to match (prevent 0/0 elite)
            if (item.dividends && item.dividends.length > 0) {
                if (metCriteriaCount === item.dividends.length) {
                    tds += `<div style="margin-top:4px;"><span style="background:var(--success); color:white; font-size:0.6rem; padding:2px 4px; border-radius:3px; font-weight:800;">‚ö° ELITE RECOVERY</span></div>`;
                } else if (metCriteriaCount > 0) {
                    tds += `<div style="margin-top:4px;"><span style="background:var(--accent-secondary); color:white; font-size:0.6rem; padding:2px 4px; border-radius:3px; font-weight:800;">‚ö° ${metCriteriaCount}/${item.dividends.length} FAST</span></div>`;
                }
            }

            tds += `</td>`;

            // Dividend Columns
            if (item.dividends && item.dividends.length > 0) {
                item.dividends.forEach(div => {
                    let content = '';

                    if (div.error) {
                        content = `<div style="color:var(--error); font-size:0.7rem; font-weight:700;">DATA ERROR</div>
                                   <div style="font-size:0.65rem; opacity:0.7;">No Price Data</div>`;
                    } else if (div.recovered) {
                        content = `<div class="div-recovered">‚úÖ ${div.recovery_days}d</div>`;
                    } else {
                        content = `<div class="div-not-recovered">‚ùå ${div.recovery_days}d</div>
                                   <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:2px;">
                                     Dist: ${div.current_distance}
                                   </div>`;
                    }

                    // Custom Window Recovery Stat (Only if not error)
                    if (!div.error) {
                        let pctClass = div.window_recv_pct >= targetPct ? 'color:#10b981' : 'color:#94a3b8'; // Dynamic Green
                        content += `<div style="font-size:0.7rem; margin-top:3px; ${pctClass}">
                                      ${recWindow}d Rec: <strong>${div.window_recv_pct}%</strong>
                                    </div>`;
                    }

                    // Tooltip or extra info
                    content += `<div style="font-size:0.65rem; color:var(--text-secondary); margin-top:4px; border-top:1px solid rgba(255,255,255,0.05); padding-top:2px;">
                                  Ex: ${div.ex_date} | <strong>$${div.amount}</strong>
                                </div>`;
                    tds += `<td>${content}</td>`;
                });

                // Fill empty cells if this ticker has fewer divs than max
                for (let i = item.dividends.length; i < maxDivs; i++) {
                    tds += `<td><span style="color:var(--glass-border)">--</span></td>`;
                }
            } else {
                // No dividends found
                tds += `<td colspan="${maxDivs}" style="color:var(--text-secondary)">No recent dividends found</td>`;
            }

            // Stats Column
            tds += `<td>
                        <div style="font-size:0.8rem;">
                           Price: <span style="font-weight:700;">$${item.current_price || 'N/A'}</span>
                        </div>
                        <div style="font-size:0.7rem; color:var(--text-secondary);">
                           Last Div: ${item.days_since_last_div !== null ? item.days_since_last_div + 'd ago' : 'N/A'}
                        </div>
                        ${item.next_div_days !== null ? `
                        <div style="font-size:0.7rem; color:var(--accent-primary); font-weight:700; margin-top:2px;">
                           Next Div: ${item.next_div_days}d (${item.next_ex_date})
                        </div>` : ''}
                    </td>`;

            tds += `<td><a href="${tvUrl}" target="_blank" class="tv-btn">View</a></td>`;

            tr.innerHTML = tds;
            tbody.appendChild(tr);
        });
    }
</script>

<div class="signature">@ORHANWOLDE</div>

</body>

</html>