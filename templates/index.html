<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woldebots | Financial Intelligence</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #030509;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --glass-bg: rgba(15, 23, 42, 0.5);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --card-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
            --accent-glow: rgba(59, 130, 246, 0.15);
        }

        * {
            box-sizing: border-box;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background:
                linear-gradient(to bottom, rgba(7, 9, 14, 0.95), rgba(7, 9, 14, 0.98)),
                url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0V0zm1 1h38v38H1V1z' fill='%23ffffff' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* Cyber Elements */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(59, 130, 246, 0.05) 50%, rgba(0, 0, 0, 0) 100%);
            opacity: 0.1;
            position: fixed;
            bottom: 100%;
            animation: scanline 8s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                bottom: 100%;
            }

            100% {
                bottom: -100px;
            }
        }

        /* W Logo Styling */
        .brand-container {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            margin-bottom: 4rem;
            margin-top: 4rem;
            animation: fadeInDown 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .logo-w {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 32px;
            color: white;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.3);
            position: relative;
        }

        .logo-w::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 9px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            z-index: -1;
            opacity: 0.5;
            filter: blur(8px);
        }

        .brand-name {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, #fff 60%, rgba(255, 255, 255, 0.4));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            /* Sharper corners for intelligence feel */
            padding: 3rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30px;
            height: 2px;
            background: var(--accent-primary);
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 30px;
            background: var(--accent-primary);
        }

        /* Professional Tabs */
        .tabs-nav {
            display: flex;
            background: rgba(15, 23, 42, 0.8);
            padding: 0.3rem;
            border-radius: 6px;
            margin-bottom: 3rem;
            border: 1px solid var(--glass-border);
            gap: 0.3rem;
            gap: 0.3rem;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-trigger {
            flex: 1;
            padding: 0.9rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }

        .tab-trigger.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .tab-trigger:hover:not(.active) {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
        }

        /* Sector Filter Pills */
        .sector-pill {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s ease;
        }

        .sector-pill:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
            color: var(--text-primary);
        }

        .sector-pill.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
        }

        .sector-pill.clear-btn {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .sector-pill.clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Sidebar Buttons */
        .sidebar-btn {
            width: 100%;
            padding: 0.5rem 0.8rem;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sidebar-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .sidebar-btn.secondary {
            background: transparent;
            color: var(--text-secondary);
        }

        .sidebar-btn.secondary:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        /* Sector Checkbox Item */
        .sector-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .sector-checkbox-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .sector-checkbox-item input[type="checkbox"] {
            accent-color: var(--accent-primary);
            width: 14px;
            height: 14px;
        }

        .sector-checkbox-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
        }

        /* Inputs & Buttons */
        textarea {
            width: 100%;
            height: 160px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1.2rem;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            margin-bottom: 1.5rem;
        }

        textarea:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
            color: white;
            padding: 1.1rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Management */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-weight: 700;
            font-size: 1.4rem;
            margin: 0;
        }

        .badge-count {
            background: var(--accent-primary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 800;
        }

        /* Table Aesthetics */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.8rem;
        }

        th {
            text-align: left;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        td {
            padding: 1.2rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid var(--glass-border);
            border-bottom: 1px solid var(--glass-border);
        }

        td:first-child {
            border-left: 1px solid var(--glass-border);
            border-radius: 12px 0 0 12px;
        }

        td:last-child {
            border-right: 1px solid var(--glass-border);
            border-radius: 0 12px 12px 0;
        }

        .ticker-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: #fff;
        }

        .spread-val {
            font-family: 'Outfit', sans-serif;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-weight: 700;
        }

        .tv-btn {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid transparent;
        }

        .tv-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        /* New Badge */
        .new-indicator {
            background: var(--success);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 900;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Indicator */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-dot.processing {
            background: var(--accent-primary);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.4;
            }
        }

        /* Copy Button */
        .btn-outline {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Mission Control Inputs */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .range-controls-grid,
        .imbalance-controls-grid,
        .dividend-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1.5rem;
        }

        .control-item>label {
            display: block;
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.8rem;
        }

        .control-item input:not([type="checkbox"]) {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 0.8rem;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
        }

        .master-list-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Cyber Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }

        .switch input {
            display: none !important;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 2px;
        }

        input:checked+.slider {
            background-color: var(--accent-primary);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
            background-color: white;
        }

        /* Smaller Switch for nested controls */
        .switch-sm {
            width: 32px;
            height: 18px;
        }

        .switch-sm .slider:before {
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 2px;
        }

        .switch-sm input:checked+.slider:before {
            transform: translateX(14px);
        }

        /* Progress Area */
        .progress-area {
            background: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid var(--glass-border);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .progress-track {
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
            transition: width 0.4s ease;
        }

        /* Signature Animation */
        .signature {
            position: fixed;
            bottom: 15px;
            right: 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.65rem;
            color: var(--text-secondary);
            opacity: 0.2;
            letter-spacing: 3px;
            pointer-events: none;
            text-transform: uppercase;
            font-weight: 900;
            animation: ghost-flicker 10s infinite;
        }

        @keyframes ghost-flicker {

            0%,
            100% {
                opacity: 0.2;
            }

            45% {
                opacity: 0.2;
            }

            50% {
                opacity: 0.05;
            }

            55% {
                opacity: 0.25;
            }

            60% {
                opacity: 0.2;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dividend Recovery Styles */
        .div-recovered {
            color: var(--success);
            font-weight: 700;
        }

        .div-not-recovered {
            color: var(--error);
            font-weight: 700;
        }

        .div-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 800;
        }

        .control-item select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 0.8rem;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }

        /* Premium Intel Hub Components */
        .intel-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
            margin-top: 2rem;
            margin-bottom: 3rem;
            position: relative;
            z-index: 1;
        }

        .config-terminal {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .range-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mini-label {
            position: absolute;
            bottom: -18px;
            left: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mini-label span {
            font-size: 0.55rem;
            font-weight: 800;
            color: var(--text-secondary);
            opacity: 0.7;
            letter-spacing: 0.5px;
        }

        /* Custom Checkbox */
        .cyber-check {
            appearance: none;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .cyber-check:checked {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .cyber-check:checked::after {
            content: 'âœ“';
            font-size: 9px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }

        .intel-module {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .intel-module:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(67, 97, 238, 0.3);
            transform: translateY(-2px);
        }

        .intel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 0.75rem;
        }

        .intel-header label {
            margin: 0 !important;
            font-size: 0.7rem !important;
            letter-spacing: 1.5px !important;
            color: var(--accent-primary) !important;
            opacity: 0.8;
        }

        .unit-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .unit-wrapper input {
            padding-right: 3rem !important;
            background: rgba(0, 0, 0, 0.5) !important;
            border: 1px solid var(--glass-border) !important;
            color: white !important;
            width: 100%;
            border-radius: 4px;
            padding: 0.8rem;
        }

        .unit-tag {
            position: absolute;
            right: 1rem;
            font-size: 0.65rem;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            pointer-events: none;
            opacity: 0.6;
        }

        .sub-terminal {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(0, 0, 0, 0) 100%);
            border: 1px solid rgba(67, 97, 238, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .textarea-premium {
            height: 100%;
            min-height: 380px;
            resize: none;
            background: rgba(0, 0, 0, 0.6) !important;
            border: 1px solid var(--glass-border) !important;
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 0.85rem !important;
            line-height: 1.6 !important;
            padding: 1.5rem !important;
        }

        label.switch-pro {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 20px;
            margin: 0;
            vertical-align: middle;
        }

        .switch-pro input {
            display: none !important;
        }

        .switch-pro .slider-pro {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        .switch-pro .slider-pro:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }

        .switch-pro input:checked+.slider-pro {
            background-color: var(--accent-primary);
        }

        .switch-pro input:checked+.slider-pro:before {
            transform: translateX(18px);
            background-color: white;
        }

        .win-rate-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
        }
    </style>
</head>

<div class="scanline"></div>
<div class="container">
    <header class="brand-container">
        <div class="logo-w">W</div>
        <h1 class="brand-name">Woldebots</h1>
    </header>

    <nav class="tabs-nav">
        <button class="tab-trigger active" onclick="switchTab('custom', this)" data-tab="custom">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                </path>
            </svg>
            Range Intelligence
        </button>
        <button class="tab-trigger" onclick="switchTab('imbalance', this)" data-tab="imbalance">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Imbalance AI
        </button>
        <button class="tab-trigger" onclick="switchTab('dividend', this)" data-tab="dividend">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
            </svg>
            Dividend Recovery
        </button>
        <button class="tab-trigger" onclick="switchTab('rebalance', this)" data-tab="rebalance">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
            </svg>
            Rebalance Patterns
        </button>
    </nav>

    <!-- Dynamic Content Area -->
    <main id="mainContainer">

        <!-- Range AI Section -->
        <section id="customSection" class="glass-card" style="animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Range AI Control
                        Panel</h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="rangeMasterList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="labelMasterList" onclick="openMasterListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                Master
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="rangeCefList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="labelCefList" onclick="openCEFListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                CEF
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="rangePffList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="labelPffList" onclick="openPFFModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                PFF
                                Holdings</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Target Nodes (Separated by Newline)</label>
                    <textarea id="tickers" placeholder="AAPL&#10;TSLA&#10;NVDA..."></textarea>
                </div>
                <div class="range-controls-grid">
                    <div class="control-item">
                        <label>Active Logic</label>
                        <div
                            style="font-size:0.8rem; color:var(--text-secondary); background:var(--surface-hover); padding:0.5rem; border-radius:4px;">
                            Phase 3 Advanced
                        </div>
                    </div>
                    <div class="control-item">
                        <label>Lookback</label>
                        <div style="font-weight:700; color:var(--accent-primary);">90 Days</div>
                    </div>
                    <div class="control-item" style="grid-column: span 2;">
                        <label>Hardcoded Filters</label>
                        <div style="display:flex; flex-wrap:wrap; gap:0.5rem; font-size:0.75rem;">
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">ATR/P
                                &le; 2.2%</span>
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">ADX
                                &le; 22</span>
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">Slope
                                &le; 3%</span>
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">Touch
                                &ge; 5</span>
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">MidZone
                                &ge; 60%</span>
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">Max Vol
                                &le; 5%</span>
                            <span style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">Gap
                                &le; 1.2%</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeBtn" onclick="startRangeAnalysis()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Identify Range Stability
            </button>

            <div id="progressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="progressText">Initializing Range AI...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>



        <!-- Imbalance AI Section -->
        <section id="imbalanceSection" class="glass-card" style="display:none; animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Imbalance AI Terminal
                    </h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="imbMasterList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="imbLabelMasterList" onclick="openMasterListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                Master
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="imbCefList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="imbLabelCefList" onclick="openCEFListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                CEF
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="imbPffList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="imbLabelPffList" onclick="openPFFModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                PFF
                                Holdings</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Target Nodes</label>
                    <textarea id="imbalanceTickers" placeholder="AAPL&#10;MSFT..."></textarea>
                </div>
                <div class="imbalance-controls-grid">
                    <div class="control-item">
                        <label>Search Period</label>
                        <div class="unit-wrapper">
                            <input type="number" id="imbDays" value="30" min="1" max="180">
                            <span class="unit-tag">Days</span>
                        </div>
                    </div>
                    <div class="control-item">
                        <label>Min Occurrences</label>
                        <input type="number" id="imbMinCount" value="6" min="1">
                    </div>
                    <!-- Max Wick Ratio with Toggle -->
                    <div class="control-item">
                        <label style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Max Wick Ratio</span>
                            <input type="checkbox" id="imbFilterWick" class="cyber-check" checked
                                onchange="toggleInput('imbMaxWick', this)">
                        </label>
                        <input type="number" id="imbMaxWick" value="0.12" step="0.01" min="0">
                    </div>
                    <!-- Min End Day Profit with Toggle -->
                    <div class="control-item">
                        <label style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Min End Profit</span>
                            <input type="checkbox" id="imbFilterProfit" class="cyber-check"
                                onchange="toggleInput('imbMinProfit', this)">
                        </label>
                        <div class="unit-wrapper">
                            <input type="number" id="imbMinProfit" value="0.10" step="0.01" min="0" disabled
                                style="opacity:0.5;">
                            <span class="unit-tag">$</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeImbalanceBtn" onclick="startImbalanceAnalysis()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Identify Imbalance Patterns
            </button>

            <div id="imbProgressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="imbProgressText">Scanning Patterns...</span>
                    <span id="imbProgressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="imbProgressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>

        <!-- Dividend Recovery Section -->
        <section id="dividendSection" class="glass-card" style="display:none; animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Dividend Recovery
                        Terminal</h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="divMasterList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="divLabelMasterList" onclick="openMasterListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                Master
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="divCefList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="divLabelCefList" onclick="openCEFListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                CEF
                                List</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="divPffList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="divLabelPffList" onclick="openPFFModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                PFF
                                Holdings</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="intel-grid">
                <!-- LEFT: NODES ENTRY -->
                <div class="input-group">
                    <div class="intel-header">
                        <label>TARGET NODES</label>
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24" style="opacity:0.5">
                            <path d="M4 6h16M4 12h16M4 18h7"></path>
                        </svg>
                    </div>
                    <textarea id="dividendTickers" class="textarea-premium"
                        placeholder="BAC-Q&#10;PCG-G&#10;T-C..."></textarea>
                </div>

                <!-- RIGHT: CONFIGURATION TERMINAL -->
                <div class="config-terminal">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <!-- Lookback Module -->
                        <div class="intel-module">
                            <div class="intel-header">
                                <label>LOOKBACK</label>
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                                    viewBox="0 0 24 24" style="opacity:0.5">
                                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <select id="divLookback"
                                style="width:100%; background:rgba(0,0,0,0.5); border:1px solid var(--glass-border); border-radius:4px; padding:0.8rem; color:white;">
                                <option value="3">Last 3 Dividends</option>
                                <option value="4">Last 4 Dividends</option>
                                <option value="5">Last 5 Dividends</option>
                            </select>
                        </div>

                        <!-- Sort Module -->
                        <div class="intel-module">
                            <div class="intel-header">
                                <label>SORT LOGIC</label>
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                                    viewBox="0 0 24 24" style="opacity:0.5">
                                    <path d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                                </svg>
                            </div>
                            <select id="divSort"
                                style="width:100%; background:rgba(0,0,0,0.5); border:1px solid var(--glass-border); border-radius:4px; padding:0.8rem; color:white;">
                                <option value="fastest">Fastest Recovery</option>
                                <option value="slowest">Slowest Recovery</option>
                                <option value="next_div">Upcoming Dividend</option>
                            </select>

                            <!-- Volume Surge Filter -->
                            <div
                                style="margin-top:12px; display:flex; align-items:center; gap:8px; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.1);">
                                <label class="switch-pro" style="transform: scale(0.85);">
                                    <input type="checkbox" id="divVolFilter">
                                    <span class="slider-pro"></span>
                                </label>
                                <span style="font-size:0.7rem; font-weight:700; color:#f59e0b;">
                                    VOL SURGE ONLY
                                </span>
                            </div>
                        </div>

                        <!-- Recovery Window Module -->
                        <div class="intel-module">
                            <div class="intel-header">
                                <label>RECOVERY WINDOW</label>
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                                    viewBox="0 0 24 24" style="opacity:0.5">
                                    <path
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </div>
                            <div class="unit-wrapper">
                                <input type="number" id="divRecWindow" value="5" min="1" max="30">
                                <span class="unit-tag">Days</span>
                            </div>
                        </div>

                        <!-- Recovery Range Module -->
                        <div class="intel-module">
                            <div class="intel-header">
                                <label>RECOVERY RANGE</label>
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <label class="switch-pro" style="transform: scale(0.8);">
                                        <input type="checkbox" id="divStrictFilter">
                                        <span class="slider-pro"></span>
                                    </label>
                                    <span style="font-size:0.6rem; font-weight:800; opacity:0.6;">STRICT</span>
                                </div>
                            </div>
                            <div class="range-wrapper" style="margin-top: 5px;">
                                <div style="flex:1; position:relative;">
                                    <div class="unit-wrapper">
                                        <input type="number" id="divTargetPct" value="90" min="0" max="100">
                                        <span class="unit-tag">%</span>
                                    </div>
                                    <label class="mini-label">
                                        <input type="checkbox" id="chkMin" class="cyber-check" checked
                                            onchange="toggleInput('divTargetPct', this)">
                                        <span>MIN</span>
                                    </label>
                                </div>
                                <div style="flex:1; position:relative;">
                                    <div class="unit-wrapper">
                                        <input type="number" id="divMaxTargetPct" value="100" min="0" max="100">
                                        <span class="unit-tag">%</span>
                                    </div>
                                    <label class="mini-label">
                                        <input type="checkbox" id="chkMax" class="cyber-check" checked
                                            onchange="toggleInput('divMaxTargetPct', this)">
                                        <span>MAX</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- UPCOMING FILTER SUB-TERMINAL -->
                    <div class="sub-terminal">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                            <div style="display:flex; align-items:center; gap:0.75rem;">
                                <div
                                    style="width:8px; height:8px; border-radius:50%; background:var(--accent-primary); box-shadow:0 0 10px var(--accent-primary);">
                                </div>
                                <h3
                                    style="margin:0; font-size:0.9rem; letter-spacing:1px; text-transform:uppercase; font-weight:800;">
                                    Upcoming Ex-Date Radar</h3>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <label class="switch-pro">
                                    <input type="checkbox" id="divUpcomingFilter">
                                    <span class="slider-pro"></span>
                                </label>
                                <span style="font-size:0.65rem; font-weight:800; color:var(--text-secondary);">ACTIVE
                                    RADAR</span>
                            </div>
                        </div>

                        <div
                            style="display:flex; align-items:center; gap:1.5rem; background:rgba(0,0,0,0.5); padding:1rem; border-radius:8px;">
                            <div style="flex:1;">
                                <div
                                    style="font-size:0.65rem; font-weight:800; color:var(--text-secondary); margin-bottom:0.5rem; text-transform:uppercase;">
                                    Scan Horizon</div>
                                <div class="unit-wrapper">
                                    <input type="number" id="divUpcomingDays" value="14" min="1" max="90"
                                        style="background:transparent; border:none; padding-left:0 !important; font-size:1.2rem;">
                                    <span class="unit-tag">Days</span>
                                </div>
                                <div style="margin-top: 8px;">
                                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                        <input type="checkbox" id="divIncludeToday" class="cyber-check">
                                        <span
                                            style="font-size:0.65rem; font-weight:800; color:var(--text-secondary); opacity:0.8;">INCLUDE
                                            TODAY</span>
                                    </label>
                                </div>
                            </div>
                            <div style="width:1px; height:40px; background:rgba(255,255,255,0.05);"></div>
                            <div style="flex:2; font-size:0.75rem; color:var(--text-secondary); line-height:1.4;">
                                Filters results to only show tickers with an ex-dividend date within the specified
                                horizon.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeDividendBtn" onclick="startDividendAnalysis()"
                style="margin-top: 1rem; position: relative; z-index: 10;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                Analyze Dividend Recovery
            </button>

            <div id="divProgressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="divProgressText">Analyzing Dividends...</span>
                    <span id="divProgressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="divProgressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>

        <!-- Rebalance Patterns Section -->
        <section id="rebalanceSection" class="glass-card" style="display:none; animation: slideIn 0.6s ease-out;">
            <div style="margin-bottom: 2rem;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.4rem;">Rebalance Pattern
                        Terminal</h2>
                    <div class="master-list-control">
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="rebMasterList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="rebLabelMasterList" onclick="openMasterListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                Master List</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="rebCefList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="rebLabelCefList" onclick="openCEFListModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                CEF List</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-left:1rem;">
                            <label class="switch">
                                <input type="checkbox" id="rebPffList" onchange="updateControlColors()">
                                <span class="slider"></span>
                            </label>
                            <span id="rebLabelPffList" onclick="openPFFModal()"
                                style="font-size:0.85rem; font-weight:700; color:var(--text-secondary); cursor:pointer;">Analyze
                                PFF Holdings</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="intel-grid">
                <div class="input-group">
                    <div class="intel-header">
                        <label>TARGET NODES</label>
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24" style="opacity:0.5">
                            <path d="M4 6h16M4 12h16M4 18h7"></path>
                        </svg>
                    </div>
                    <textarea id="rebalanceTickers" class="textarea-premium" placeholder="AAPL&#10;MSFT..."></textarea>
                </div>

                <div class="config-terminal">
                    <div class="intel-module">
                        <div class="intel-header">
                            <label>LOOKBACK PERIOD</label>
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                                viewBox="0 0 24 24" style="opacity:0.5">
                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <select id="rebMonths"
                            style="width:100%; background:rgba(0,0,0,0.5); border:1px solid var(--glass-border); border-radius:4px; padding:0.8rem; color:white;">
                            <option value="1">Last 1 Month</option>
                            <option value="2">Last 2 Months</option>
                            <option value="3" selected>Last 3 Months</option>
                            <option value="4">Last 4 Months</option>
                            <option value="5">Last 5 Months</option>
                            <option value="6">Last 6 Months</option>
                        </select>
                    </div>
                    <div style="margin-top:1rem; color:var(--text-secondary); font-size:0.85rem; line-height: 1.5;">
                        <p>Analyzes price performance in the 3 trading days before and after each month-end rebalance
                            day (last business day).</p>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="analyzeRebalanceBtn" onclick="startRebalanceAnalysis()"
                style="margin-top: 1rem;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Analyze Rebalance Patterns
            </button>

            <div id="rebProgressContainer" class="progress-area" style="display:none; margin-top:2rem;">
                <div class="progress-header">
                    <span id="rebProgressText">Analyzing Patterns...</span>
                    <span id="rebProgressPercent">0%</span>
                </div>
                <div class="progress-track">
                    <div id="rebProgressFill" class="progress-fill"></div>
                </div>
            </div>
        </section>

        <!-- Range AI Results Area -->
        <section id="customResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Range Stability Output</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        High-probability stability nodes identified by Range AI filters.
                    </p>
                </div>
                <div>
                    <span class="badge" id="rangeMatchCount">0 Symbols Found</span>
                    <button class="tv-btn" onclick="copyToClipboard('custom', this)">Copy Symbols</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="customResultsTable">
                    <thead>
                        <tr>
                            <th style="cursor:pointer;" onclick="sortRangeResults('ticker')">Ticker â†•</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('percent_range')">% Range â†•</th>
                            <th>Current / Range</th>
                            <th>Signal</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('atr_price_pct')">ATR/P â†•</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('adx')">ADX â†•</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('slope_pct')">Slope â†•</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('max_daily_move')">Max Vol â†•</th>
                            <th>Touch (L/H)</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('middle_ratio')">Mid% â†•</th>
                            <th style="cursor:pointer;" onclick="sortRangeResults('avg_total_cycle')">Cycle â†•</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Smart Watchlist results removed -->

        <!-- Imbalance AI Results Area -->
        <section id="imbalanceResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Imbalance Pattern Output</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        Directional liquidity imbalances detected in recent sessions.
                    </p>
                </div>
                <div>
                    <span id="imbMatchCount" class="badge">0 Symbols Found</span>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end;">
                        <button class="tv-btn" onclick="copyToClipboard('imbalance', this)">Copy All</button>
                        <button class="tv-btn" style="background: rgba(16,185,129,0.2); border-color: var(--success);"
                            onclick="copyToClipboard('imbalance', this, 'Green')">Copy Green</button>
                        <button class="tv-btn" style="background: rgba(239,68,68,0.2); border-color: var(--error);"
                            onclick="copyToClipboard('imbalance', this, 'Red')">Copy Red</button>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table id="imbalanceResultsTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Pattern</th>
                            <th>Match Count</th>
                            <th>Avg Diff (Wick)</th>
                            <th>Avg End $</th>
                            <th>Avg Max $</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Dividend Recovery Results Area -->
        <section id="dividendResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Dividend Recovery Analysis</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        Recovery timeline tracking for post-dividend price movements.
                    </p>
                </div>
                <div>
                    <span id="divMatchCount" class="badge">0 Symbols Analyzed</span>
                    <button class="tv-btn" onclick="copyToClipboard('dividend', this)">Copy Symbols</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="dividendResultsTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Div #1</th>
                            <th>Div #2</th>
                            <th>Div #3</th>
                            <th>
                                <div style="display:flex; align-items:center; gap:6px;">
                                    STATS
                                    <div onclick="document.getElementById('divSort').value='next_div'; renderDividendResults(dataStore.dividend); event.stopPropagation();"
                                        title="Sort by Next Dividend Date"
                                        style="cursor:pointer; background:rgba(255,255,255,0.1); border-radius:4px; padding:2px 4px; display:flex; align-items:center; transition:0.2s;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                    </div>
                                </div>
                            </th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Rebalance Patterns Results Area -->
        <section id="rebalanceResultsCard" class="glass-card" style="display:none; animation: slideUp 0.6s ease-out;">
            <div class="results-header">
                <div>
                    <h2 class="results-title">Rebalance Pattern Analysis</h2>
                    <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.3rem;">
                        Average performance and win rates around month-end rebalancing windows.
                    </p>
                </div>
                <div>
                    <span id="rebMatchCount" class="badge">0 Symbols Analyzed</span>
                    <button class="tv-btn" onclick="copyToClipboard('rebalance', this)">Copy Symbols</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="rebalanceResultsTable">
                    <thead>
                        <tr>
                            <th onclick="sortRebalance('ticker')" style="cursor:pointer;">Ticker â†•</th>
                            <th onclick="sortRebalance('avg_pre_3_diff')" style="cursor:pointer;">Pre-3 ($) â†•</th>
                            <th onclick="sortRebalance('avg_reba_body_diff')" style="cursor:pointer;">Reba ($) â†•</th>
                            <th onclick="sortRebalance('avg_post_3_diff')" style="cursor:pointer;">Post-3 ($) â†•</th>
                            <th onclick="sortRebalance('pre_3_std_pct')" style="cursor:pointer;"
                                title="Pre-3 Standard Deviation (%)">Pre SD â†•</th>
                            <th onclick="sortRebalance('reba_body_std_pct')" style="cursor:pointer;"
                                title="Rebalance Day Standard Deviation (%)">Reb SD â†•</th>
                            <th onclick="sortRebalance('post_3_std_pct')" style="cursor:pointer;"
                                title="Post-3 Standard Deviation (%)">Post SD â†•</th>
                            <th onclick="sortRebalance('volume')" style="cursor:pointer;"
                                title="90d Avg | Pre Avg | Reb Day | Post Avg">Volume Detailed â†•</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- No Results Message -->
        <div id="noResults"
            style="display:none; text-align:center; padding:3rem 0; color:var(--text-secondary); font-style:italic;">
            No datasets matched the defined intelligence parameters.
        </div>
    </main>
</div>

<script>
    let jobId = null;
    let pollInterval = null;

    // Track unique polling cycles to prevent zombies
    let pollTimers = {
        imbalance: null
    };

    let dataStore = {
        custom: [], // This will now store Range AI results
        imbalance: [],
        rebalance: []
    };

    let currentTab = 'custom';

    function switchTab(tab, el) {
        if (tab === currentTab) return;
        currentTab = tab;
        console.log("Switching to tab:", tab);

        // UI Visual Update
        document.querySelectorAll('.tab-trigger').forEach(b => b.classList.remove('active'));
        if (el) {
            el.classList.add('active');
        } else {
            const btns = Array.from(document.querySelectorAll('.tab-trigger'));
            const target = btns.find(b => b.getAttribute('data-tab') === tab);
            if (target) target.classList.add('active');
        }

        // Hide sections and result cards
        ['custom', 'imbalance', 'dividend', 'rebalance'].forEach(t => {
            document.getElementById(`${t}Section`).style.display = 'none';
            document.getElementById(`${t}ResultsCard`).style.display = 'none';
        });
        document.getElementById('noResults').style.display = 'none';

        if (tab === 'custom') {
            document.getElementById('customSection').style.display = 'block';
            if (dataStore.custom.length > 0) {
                renderResults('custom', dataStore.custom);
            }
        } else if (tab === 'imbalance') {
            document.getElementById('imbalanceSection').style.display = 'block';
            if (dataStore.imbalanceResults && dataStore.imbalanceResults.length > 0) {
                renderImbalanceResults(dataStore.imbalanceResults);
            }
        } else if (tab === 'dividend') {
            document.getElementById('dividendSection').style.display = 'block';
            if (dataStore.dividend && dataStore.dividend.length > 0) {
                renderDividendResults(dataStore.dividend);
            }
        } else if (tab === 'rebalance') {
            document.getElementById('rebalanceSection').style.display = 'block';
            if (dataStore.rebalance && dataStore.rebalance.length > 0) {
                renderRebalanceResults(dataStore.rebalance);
            }
        }
    }

    async function stopImbalance() {
        await fetch('/stop_imbalance', { method: 'POST' });
    }

    async function startRangeAnalysis() {
        const masterToggle = document.getElementById('rangeMasterList');
        const cefToggle = document.getElementById('rangeCefList');
        const pffToggle = document.getElementById('rangePffList');
        let tickers = [];
        if (cefToggle.checked) {
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (pffToggle.checked) {
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerText = "Preparing PFF List...";
            try {
                // Ensure we have PFF data (fetched from modal or fetch now)
                if (pffRawData.length === 0) {
                    const tRes = await fetch('/get_pff_holdings');
                    const tData = await tRes.json();
                    pffRawData = tData.holdings || [];
                }

                // Use filtered list if sectors are selected
                if (pffSelectedSectors.size > 0) {
                    tickers = pffRawData.filter(h => pffSelectedSectors.has(h.sector)).map(h => h.ticker);
                } else {
                    tickers = pffRawData.map(h => h.ticker);
                }
            } catch (e) {
                alert("Failed to load PFF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerText = "Preparing Master List...";
            try {
                // Ensure we have Master List data
                if (masterListRawData.length === 0) {
                    const tRes = await fetch('/get_master_list_tickers');
                    const tData = await tRes.json();
                    masterListRawData = tData.tickers || [];
                }

                // Use filtered list if sectors are selected
                if (masterListSelectedSectors.size > 0) {
                    tickers = masterListRawData.filter(t => masterListSelectedSectors.has(t.sector)).map(t => t.ticker);
                } else {
                    tickers = masterListRawData.map(t => t.ticker);
                }
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('tickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('analyzeBtn').innerText = "Analyzing Range...";
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('noResults').style.display = 'none';

        // Clear data store
        dataStore.custom = [];

        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 3;

        updateProgress(0, `Initializing Range AI for ${total} tickers...`);

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                // Accuracy Tuning: Batch fetch with retry
                let data = null;
                let retries = 2;
                while (retries >= 0) {
                    try {
                        const formData = new FormData();
                        formData.append('tickers', batchStr);
                        // Phase 3 hardcoded logic - no params needed from frontend
                        formData.append('days', 90);

                        updateProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                        const res = await fetch('/analyze_range_batch', { method: 'POST', body: formData });
                        data = await res.json();
                        if (data.error) throw new Error(data.error);
                        break; // Success
                    } catch (err) {
                        console.warn(`Retry ${2 - retries} for batch ${batchStr}: ${err.message}`);
                        retries--;
                        if (retries < 0) throw err;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (data.results && data.results.length > 0) {
                    dataStore.custom = [...(dataStore.custom || []), ...data.results];
                    renderResults('custom', dataStore.custom);
                }

                completed += batch.length;
                updateProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);

                await new Promise(r => setTimeout(r, 400));
            }

            updateProgress(100, "Range Analysis Complete");

            if (!dataStore.custom || dataStore.custom.length === 0) {
                document.getElementById('noResults').style.display = 'block';
            }

        } catch (e) {
            console.error(e);
            alert("Scan Error: " + e.message);
        } finally {
            resetUI();
        }
    }



    function updateProgress(percent, text) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressPercent').innerText = percent + '%';
        document.getElementById('progressText').innerText = text;
    }

    async function startImbalanceAnalysis() {
        const masterToggle = document.getElementById('imbMasterList');
        const cefToggle = document.getElementById('imbCefList');
        const pffToggle = document.getElementById('imbPffList');
        let tickers = [];

        if (cefToggle.checked) {
            document.getElementById('analyzeImbalanceBtn').disabled = true;
            document.getElementById('analyzeImbalanceBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (pffToggle.checked) {
            document.getElementById('analyzeImbalanceBtn').disabled = true;
            document.getElementById('analyzeImbalanceBtn').innerText = "Loading PFF List...";
            try {
                const tRes = await fetch('/get_pff_holdings');
                const tData = await tRes.json();
                tickers = tData.holdings ? tData.holdings.map(h => h.ticker) : [];
            } catch (e) {
                alert("Failed to load PFF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeImbalanceBtn').disabled = true;
            document.getElementById('analyzeImbalanceBtn').innerText = "Loading Master List...";
            try {
                const tRes = await fetch('/get_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('imbalanceTickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeImbalanceBtn').disabled = true;
        document.getElementById('analyzeImbalanceBtn').innerText = "Analyzing Patterns...";
        document.getElementById('imbProgressContainer').style.display = 'block';
        document.getElementById('imbalanceResultsCard').style.display = 'none';
        document.querySelector('#imbalanceResultsTable tbody').innerHTML = '';
        document.getElementById('noResults').style.display = 'none';

        // Clear data store
        dataStore.imbalanceResults = [];

        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 3;

        updateImbProgress(0, `Initializing scan for ${total} tickers...`);

        // NEW PARAMS
        const days = document.getElementById('imbDays').value;
        const minCount = document.getElementById('imbMinCount').value;
        const maxWick = document.getElementById('imbMaxWick').value;

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                // Accuracy Tuning: Batch fetch with retry
                let data = null;
                let retries = 2;
                while (retries >= 0) {
                    try {
                        const formData = new FormData();
                        formData.append('tickers', batchStr);
                        formData.append('days', days);
                        formData.append('min_count', minCount);

                        // Handle Toggles
                        const filterWick = document.getElementById('imbFilterWick').checked;
                        const filterProfit = document.getElementById('imbFilterProfit').checked;

                        formData.append('filter_wick', filterWick);
                        formData.append('max_wick', filterWick ? document.getElementById('imbMaxWick').value : 999);

                        formData.append('filter_profit', filterProfit);
                        formData.append('min_profit', filterProfit ? document.getElementById('imbMinProfit').value : 0);

                        updateImbProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                        const res = await fetch('/analyze_imbalance_batch', { method: 'POST', body: formData });
                        data = await res.json();
                        if (data.error) throw new Error(data.error);
                        break; // Success
                    } catch (err) {
                        console.warn(`Retry ${2 - retries} for batch ${batchStr}: ${err.message}`);
                        retries--;
                        if (retries < 0) throw err;
                        await new Promise(r => setTimeout(r, 1000)); // Wait before retry
                    }
                }

                if (data.results && data.results.length > 0) {
                    dataStore.imbalanceResults = [...(dataStore.imbalanceResults || []), ...data.results];
                    renderImbalanceResults(dataStore.imbalanceResults);
                }

                completed += batch.length;
                updateImbProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);

                // Accuracy Tuning: Increased delay between batches
                // This prevents heavy load and allows Vercel workers some breathing room
                await new Promise(r => setTimeout(r, 400));
            }

            updateImbProgress(100, "Scan Complete");

            if (!dataStore.imbalanceResults || dataStore.imbalanceResults.length === 0) {
                renderImbalanceResults([]);
            }

        } catch (e) {
            console.error(e);
            alert("Scan Error: " + e.message);
        } finally {
            resetUI();
        }
    }

    // Removed imbPollStatus as it is no longer needed

    function updateImbProgress(percent, text) {
        document.getElementById('imbProgressFill').style.width = percent + '%';
        document.getElementById('imbProgressPercent').innerText = percent + '%';
        document.getElementById('imbProgressText').innerText = text;
    }

    function renderImbalanceResults(results) {
        if (!results || results.length === 0) {
            document.getElementById('imbalanceResultsCard').style.display = 'none';

            // Show strict "No Results" message
            const noRes = document.getElementById('noResults');
            noRes.style.display = 'block';
            noRes.innerHTML = `
                    <div style="text-align:center; padding:2rem;">
                        <span style="font-size:2rem;">ðŸ”</span>
                        <h3>No Matches Found</h3>
                        <p style="color:var(--text-secondary)">
                            No tickers matched your strict criteria (Min Count, Max Wick).<br>
                            Try reducing the <b>Min Occurrences</b> or increasing <b>Max Wick</b>.
                        </p>
                    </div>
                `;
            return;
        }

        document.getElementById('imbalanceResultsCard').style.display = 'block';
        document.getElementById('imbMatchCount').innerText = `${results.length} Matches`;

        const tbody = document.querySelector('#imbalanceResultsTable tbody');
        tbody.innerHTML = '';

        results.sort((a, b) => a.ticker.localeCompare(b.ticker)).forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            // Style badge based on color
            const color = item.target_color || 'Green';
            const badgerStyle = color === 'Green' ?
                'background:rgba(16,185,129,0.1); color:var(--success)' :
                'background:rgba(239,68,68,0.1); color:var(--error)';

            const displayDays = item.days || item.total_days || 30;
            const displayWick = item.max_wick || 0.12;
            const detailStr = `(LAST ${displayDays} DAYS | WICK <= ${displayWick})`;

            tr.innerHTML = `
                    <td>
                        <div style="display:flex; align-items:center;">
                            <span class="ticker-name">${item.ticker}</span>
                            ${item.is_new ? '<span class="new-indicator">New</span>' : ''}
                        </div>
                        <div style="font-size:0.75rem; color:var(--text-secondary); margin-top:4px;">
                            ${detailStr}
                        </div>
                    </td>
                    <td><span class="spread-val" style="${badgerStyle}">${color} Candle</span></td>
                    <td>${item.match_count}</td>
                    <td>${item.avg_diff}</td>
                    <!-- New Profit Columns -->
                    <td style="font-weight:600; color:${item.avg_end_profit > 0 ? 'var(--success)' : 'var(--text-secondary)'}">
                        ${item.avg_end_profit > 0 ? '+' : ''}${item.avg_end_profit}
                    </td>
                    <td style="font-weight:600; color:var(--success)">
                        +${item.avg_max_profit}
                    </td>
                    <td><a href="${tvUrl}" target="_blank" class="tv-btn">View Nodes</a></td>
                `;
            tbody.appendChild(tr);
        });

        document.getElementById('noResults').style.display = 'none';
    }

    function copyImbalanceTickers() {
        if (!dataStore.imbalanceResults) return;
        const tickers = dataStore.imbalanceResults.map(r => r.ticker).join(',');
        navigator.clipboard.writeText(tickers).then(() => {
            const btn = event.target;
            const oldText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = oldText, 2000);
        });
    }

    // --- Range Sorting Logic ---
    let rangeSortState = { column: 'ticker', direction: 'asc' };

    function sortRangeResults(col) {
        if (!dataStore || !dataStore.custom || dataStore.custom.length === 0) return;

        // Toggle direction if clicking same column
        if (rangeSortState.column === col) {
            rangeSortState.direction = rangeSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            rangeSortState.column = col;
            // Default to desc for numeric, asc for ticker
            rangeSortState.direction = col === 'ticker' ? 'asc' : 'desc';
        }

        const dir = rangeSortState.direction === 'asc' ? 1 : -1;

        dataStore.custom.sort((a, b) => {
            let valA = a[col];
            let valB = b[col];

            if (valA === null || valA === undefined) valA = -999999;
            if (valB === null || valB === undefined) valB = -999999;

            if (typeof valA === 'string' && typeof valB === 'string') {
                return valA.localeCompare(valB) * dir;
            }
            return (valA - valB) * dir;
        });

        renderResults('custom', dataStore.custom);
    }
    function renderResults(type, results) {
        if (!results) return;

        // Persistent storage check before UI filtering
        if (results && results.length > 0) {
            dataStore[type] = results;
        }

        // Update match count badges
        const countId = type === 'imbalance' ? 'imbMatchCount' : (type === 'custom' ? 'rangeMatchCount' : null);
        if (countId) {
            const countEl = document.getElementById(countId);
            if (countEl) countEl.innerText = `${results.length} Symbols Found`;
        }

        // ONLY update DOM if it's the current tab
        if (currentTab !== type) return;

        // CRITICAL: Hide ALL result cards before showing the one we want
        document.getElementById('customResultsCard').style.display = 'none';
        document.getElementById('imbalanceResultsCard').style.display = 'none';

        const card = document.getElementById(`${type}ResultsCard`);
        const tbody = document.querySelector(`#${type}ResultsTable tbody`);
        const noRes = document.getElementById('noResults');

        if (results.length === 0) {
            card.style.display = 'none';
            if (currentTab === type) noRes.style.display = 'block';
            return;
        }

        card.style.display = 'block';
        noRes.style.display = 'none';
        tbody.innerHTML = '';

        if (type === 'custom') {
            // Respect current sort state if none applied yet
            results.sort((a, b) => {
                const col = rangeSortState.column || 'ticker';
                const dir = rangeSortState.direction === 'asc' ? 1 : -1;
                let valA = a[col];
                let valB = b[col];
                if (valA === null || valA === undefined) valA = -999999;
                if (valB === null || valB === undefined) valB = -999999;
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return valA.localeCompare(valB) * dir;
                }
                return (valA - valB) * dir;
            });
        }

        results.forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            if (type === 'custom') {
                // Signal Color Logic
                let signalBadge = '';
                if (item.signal === 'Buy') {
                    signalBadge = `<span class="spread-val">BUY ZONE</span>`;
                } else if (item.signal === 'Sell') {
                    signalBadge = `<span class="spread-val" style="color:var(--nd:rgba(239,68,68,0.1);">SELL ZONE</span>`;
                } else {
                    signalBadge = `<span style="font-size:0.75rem; color:var(--text-secondary); opacity:0.7;">Neutral</span>`;
                }

                tr.innerHTML = `
                        <td>
                            <div style="display:flex; align-items:center;">
                                <span class="ticker-name">${item.ticker}</span>
                            </div>
                            <div style="font-size:0.7rem; color:var(--text-tertiary);">R: ${item.point_range} pts</div>
                        </td>
                        <td><span style="color:var(--accent-secondary); font-weight:600;">${item.percent_range}%</span></td>
                        <td>
                            <div style="font-size:0.85rem; font-weight:600;">$${item.current}</div>
                            <div style="font-size:0.7rem; color:var(--text-tertiary);">L:$${item.min} H:$${item.max}</div>
                        </td>
                        <td>${signalBadge}</td>
                        <td style="font-weight:600; color:${item.atr_price_pct > 2.2 ? 'var(--error)' : 'var(--text-primary)'}">${item.atr_price_pct !== null ? item.atr_price_pct : '-'}%</td>
                        <td style="font-weight:600; color:${item.adx > 25 ? 'var(--warning)' : 'var(--text-secondary)'}">${item.adx !== null ? item.adx : '-'}</td>
                        <td style="color:${Math.abs(item.slope_pct) > 3 ? 'var(--error)' : 'var(--text-primary)'}">${item.slope_pct !== null ? item.slope_pct : '-'}%</td>
                        <td style="color:${item.max_daily_move > 5 ? 'var(--error)' : 'var(--text-primary)'}">${item.max_daily_move !== null ? item.max_daily_move : '-'}%</td>
                        <td>
                            <span style="color:var(--success); font-weight:700;">${item.touch_low}</span> / 
                            <span style="color:var(--error); font-weight:700;">${item.touch_high}</span>
                        </td>
                        <td style="color:${item.middle_ratio < 60 ? 'var(--error)' : 'var(--text-primary)'}">${item.middle_ratio !== null ? item.middle_ratio : '-'}%</td>
                        <td><span style="font-weight:700; color:var(--accent-primary);">${item.avg_total_cycle !== null ? Math.round(item.avg_total_cycle) : '-'}</span></td>
                        <td><a href="${tvUrl}" target="_blank" class="tv-btn">Chart</a></td>
                    `;
            }
            tbody.appendChild(tr);
        });
    }

    async function copyToClipboard(type, btnElement, filterColor) {
        let results = [];
        if (type === 'imbalance') {
            results = dataStore.imbalanceResults || [];
            if (filterColor) {
                results = results.filter(r => (r.target_color || 'Green') === filterColor);
            }
        } else if (type === 'dividend') {
            results = dataStore.dividendFiltered || dataStore.dividend || [];
        } else {
            results = dataStore[type];
        }

        if (!results || results.length === 0) {
            console.warn("No results to copy for type:", type, filterColor);
            return;
        }

        const text = results.map(r => r.ticker).join(', ');
        console.log("Copying to clipboard:", text);

        // Use provided element or fallback
        const btn = btnElement || (window.event ? window.event.target : null);

        try {
            await navigator.clipboard.writeText(text);
            showCopyFeedback(btn);
        } catch (err) {
            console.warn('Clipboard API failed, trying fallback:', err);
            fallbackCopy(text, btn);
        }
    }

    function fallbackCopy(text, btn) {
        try {
            const textArea = document.createElement("textarea");
            textArea.value = text;

            // Ensure it's not visible but part of DOM
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);

            textArea.focus();
            textArea.select();

            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (successful) {
                showCopyFeedback(btn);
            } else {
                console.error('Fallback copy failed.');
                if (btn) btn.innerText = "Failed";
            }
        } catch (err) {
            console.error('Fallback copy error:', err);
            if (btn) btn.innerText = "Error";
        }
    }

    function showCopyFeedback(btn) {
        if (!btn) return;
        const oldText = btn.innerText;
        btn.innerText = "Copied!";
        setTimeout(() => btn.innerText = oldText, 2000);
    }

    function resetUI() {
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('analyzeBtn').innerText = "Run Intelligence Report";
        document.getElementById('analyzeImbalanceBtn').disabled = false;
        document.getElementById('analyzeImbalanceBtn').innerText = "Identify Imbalance Patterns";
        document.getElementById('analyzeDividendBtn').disabled = false;
        document.getElementById('analyzeDividendBtn').innerText = "Analyze Dividend Recovery";
        if (document.getElementById('analyzeRebalanceBtn')) {
            document.getElementById('analyzeRebalanceBtn').disabled = false;
            document.getElementById('analyzeRebalanceBtn').innerText = "Analyze Rebalance Patterns";
        }
    }

    // --- Dividend Recovery Logic ---

    async function startDividendAnalysis() {
        const masterToggle = document.getElementById('divMasterList');
        const cefToggle = document.getElementById('divCefList');
        const pffToggle = document.getElementById('divPffList');
        let tickers = [];

        if (cefToggle.checked) {
            document.getElementById('analyzeDividendBtn').disabled = true;
            document.getElementById('analyzeDividendBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (pffToggle.checked) {
            document.getElementById('analyzeDividendBtn').disabled = true;
            document.getElementById('analyzeDividendBtn').innerText = "Loading PFF List...";
            try {
                const tRes = await fetch('/get_pff_holdings');
                const tData = await tRes.json();
                tickers = tData.holdings ? tData.holdings.map(h => h.ticker) : [];
            } catch (e) {
                alert("Failed to load PFF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeDividendBtn').disabled = true;
            document.getElementById('analyzeDividendBtn').innerText = "Loading Master List...";
            try {
                const tRes = await fetch('/get_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('dividendTickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeDividendBtn').disabled = true;
        document.getElementById('analyzeDividendBtn').innerText = "Analyzing Dividends...";
        document.getElementById('divProgressContainer').style.display = 'block';
        document.getElementById('dividendResultsCard').style.display = 'none';
        document.getElementById('noResults').style.display = 'none';

        // Clear data store
        // Clear data store
        dataStore.dividend = [];
        dataStore.dividendFiltered = [];

        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 4; // Slightly larger batch for dividend checks

        updateDivProgress(0, `Initializing analysis for ${total} tickers...`);

        const lookback = document.getElementById('divLookback').value;
        const recWindow = document.getElementById('divRecWindow').value;

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                // Retry logic
                let data = null;
                let retries = 2;
                while (retries >= 0) {
                    try {
                        const formData = new FormData();
                        formData.append('tickers', batchStr);
                        formData.append('lookback', lookback);
                        formData.append('recovery_window', recWindow);

                        updateDivProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                        const res = await fetch('/analyze_dividend_recovery', { method: 'POST', body: formData });
                        data = await res.json();
                        if (data.error) throw new Error(data.error);
                        break;
                    } catch (err) {
                        console.warn(`Retry ${2 - retries} for batch ${batchStr}: ${err.message} `);
                        retries--;
                        if (retries < 0) throw err;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (data.results && data.results.length > 0) {
                    dataStore.dividend = [...(dataStore.dividend || []), ...data.results];
                    renderDividendResults(dataStore.dividend);
                }

                completed += batch.length;
                updateDivProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);

                await new Promise(r => setTimeout(r, 600));
            }

            updateDivProgress(100, "Analysis Complete");

            if (!dataStore.dividend || dataStore.dividend.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('dividendResultsCard').style.display = 'none';
            }

        } catch (e) {
            console.error(e);
            alert("Analysis Error: " + e.message);
        } finally {
            resetUI();
        }
    }

    function updateDivProgress(percent, text) {
        document.getElementById('divProgressFill').style.width = percent + '%';
        document.getElementById('divProgressPercent').innerText = percent + '%';
        document.getElementById('divProgressText').innerText = text;
    }

    function renderDividendResults(results) {
        if (!results || results.length === 0) return;

        document.getElementById('dividendResultsCard').style.display = 'block';
        document.getElementById('dividendResultsCard').style.display = 'block';

        const table = document.getElementById('dividendResultsTable');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');

        // Dynamic Headers based on lookback (max count of dividends found)
        let maxDivs = 0;
        results.forEach(r => {
            if (r.dividends && r.dividends.length > maxDivs) maxDivs = r.dividends.length;
        });

        // Rebuild Headers
        thead.innerHTML = '<th>Ticker</th>';
        for (let i = 0; i < maxDivs; i++) {
            thead.innerHTML += `<th>Div #${i + 1}</th>`;
        }
        thead.innerHTML += `
            <th>
                <div style="display:flex; align-items:center; gap:6px;">
                    STATS
                    <div onclick="document.getElementById('divSort').value='next_div'; renderDividendResults(dataStore.dividend); event.stopPropagation();" 
                         title="Sort by Next Dividend Date"
                         style="cursor:pointer; background:rgba(255,255,255,0.1); border-radius:4px; padding:2px 4px; display:flex; align-items:center; transition:0.2s;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </th>
            <th>Action</th>`;

        tbody.innerHTML = '';

        // Filter and Sort Logic
        const sortType = document.getElementById('divSort').value;
        const targetPct = parseFloat(document.getElementById('divTargetPct').value) || 90;
        const recWindow = parseInt(document.getElementById('divRecWindow').value) || 5;

        // Helper to calculate score for sorting
        results.forEach(item => {
            let totalRecDays = 0;
            let totalRecPct = 0;
            let recCount = 0;

            if (item.dividends && item.dividends.length > 0) {
                item.dividends.forEach(div => {
                    if (div.recovered) {
                        totalRecDays += div.recovery_days;
                    } else {
                        totalRecDays += 999;
                    }
                    // For score: Prioritize window_recv_pct
                    totalRecPct += (div.window_recv_pct || 0);
                });
                item.avg_rec_pct = totalRecPct / item.dividends.length;
                item.avg_rec_days = totalRecDays / item.dividends.length;
            } else {
                item.avg_rec_pct = -1;
                item.avg_rec_days = 9999;
            }

            // Score Logic: High Pct is best. Low Days is tiebreaker.
            // Let's make a combined score where Higher is Better
            // Score = (AvgPct * 100) - AvgDays
            item.rec_score = (item.avg_rec_pct * 1000) - item.avg_rec_days;
        });

        // SORTING
        if (sortType === 'fastest') {
            results.sort((a, b) => {
                // Primary: Pct (Descending) - Higher is better
                if (Math.abs(a.avg_rec_pct - b.avg_rec_pct) > 0.1) {
                    return b.avg_rec_pct - a.avg_rec_pct;
                }
                // Secondary: Days (Ascending) - Lower is better
                return a.avg_rec_days - b.avg_rec_days;
            });
        } else if (sortType === 'slowest') {
            results.sort((a, b) => {
                // Primary: Pct (Ascending) - Lower is worse (slowest)
                if (Math.abs(a.avg_rec_pct - b.avg_rec_pct) > 0.1) {
                    return a.avg_rec_pct - b.avg_rec_pct;
                }
                // Secondary: Days (Descending) - Higher is slower
                return b.avg_rec_days - a.avg_rec_days;
            });
        } else if (sortType === 'next_div') {
            results.sort((a, b) => {
                const aDays = (a.next_div_days === null || a.next_div_days === undefined) ? 9999 : a.next_div_days;
                const bDays = (b.next_div_days === null || b.next_div_days === undefined) ? 9999 : b.next_div_days;
                return aDays - bDays;
            });
        }

        // STRICT FILTERING (RANGE LOGIC)
        const strictFilter = document.getElementById('divStrictFilter').checked;

        // Ensure Max >= Min logic? Or let user do whatever.
        let minTarget = parseFloat(document.getElementById('divTargetPct').value) || 0;
        let maxTarget = parseFloat(document.getElementById('divMaxTargetPct').value) || 100;

        const isMinChecked = document.getElementById('chkMin').checked;
        const isMaxChecked = document.getElementById('chkMax').checked;

        // Logic:
        // 1. If Unchecked -> Absolute Infinite Limit
        // 2. If Checked but value at limit (0 or 100) -> Smart Infinite Limit
        // 3. Else -> Use specific value

        if (!isMinChecked) {
            minTarget = -999999;
        } else if (minTarget === 0) {
            minTarget = -999999;
        }

        if (!isMaxChecked) {
            maxTarget = 999999;
        } else if (maxTarget === 100) {
            maxTarget = 999999;
        }

        let filteredResults = results;
        if (strictFilter) {
            filteredResults = results.filter(item => {
                let metCriteriaCount = 0;
                if (item.dividends && item.dividends.length > 0) {
                    item.dividends.forEach(div => {
                        // Check if recovery is within [min, max]
                        const p = div.window_recv_pct || 0;
                        if (p >= minTarget && p <= maxTarget) metCriteriaCount++;
                    });
                    // Strict means ALL dividends must be in that range?
                    return metCriteriaCount === item.dividends.length;
                }
                return false;
            });
        }

        // VOLUME SURGE FILTERING
        const volFilter = document.getElementById('divVolFilter').checked;
        if (volFilter) {
            filteredResults = filteredResults.filter(item => {
                if (!item.dividends || item.dividends.length === 0) return false;
                // Check if ALL dividends have a volume spike
                return item.dividends.every(div => {
                    return div.pre_div_14d && div.pre_div_14d.volume_spike_detected === true;
                });
            });
        }

        // UPCOMING DIV FILTERING
        const upcomingFilter = document.getElementById('divUpcomingFilter').checked;
        const upcomingDaysLimit = parseInt(document.getElementById('divUpcomingDays').value) || 14;

        if (upcomingFilter) {
            filteredResults = filteredResults.filter(item => {
                // Determine min days based on "Include Today" checkbox
                const includeToday = document.getElementById('divIncludeToday').checked;
                const minDays = includeToday ? 0 : 1;

                // Must be between minDays and X days
                return item.next_div_days !== null && item.next_div_days >= minDays && item.next_div_days <= upcomingDaysLimit;
            });
        }

        // Store filtered results for clipboard
        dataStore.dividendFiltered = filteredResults;

        // Update Counter
        document.getElementById('divMatchCount').innerText = `${results.length} Analyzed, ${filteredResults.length} Found`;

        filteredResults.forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            let tds = `<td><span class="ticker-name">${item.ticker}</span>`;

            // Check if it meets the specific "X% in Y days" criteria for ALL analyzed dividends?
            // User request: "son 3 divinin ilk 5 gÃ¼nÃ¼nde %90'Ä±nÄ± recoverlayan kaÄŸÄ±tlarÄ± ayrÄ±ca gÃ¶ster"
            // Let's count how many met the criteria
            // Elite/Fast Badge Logic (Range Based)
            let metCriteriaCount = 0;
            if (item.dividends) {
                let minT = parseFloat(document.getElementById('divTargetPct').value) || 0;
                let maxT = parseFloat(document.getElementById('divMaxTargetPct').value) || 100;
                const minC = document.getElementById('chkMin').checked;
                const maxC = document.getElementById('chkMax').checked;

                if (!minC || minT === 0) minT = -999999;
                if (!maxC || maxT === 100) maxT = 999999;

                item.dividends.forEach(div => {
                    const p = div.window_recv_pct || 0;
                    if (p >= minT && p <= maxT) metCriteriaCount++;
                });
            }

            // Highlight if ALL met criteria (or maybe simplified to 'all')?
            // Let's use a badge if it performed well in the window
            // Strict check: Must have ACTUAL dividends to match (prevent 0/0 elite)
            if (item.dividends && item.dividends.length > 0) {
                if (metCriteriaCount === item.dividends.length) {
                    tds += `<div style="margin-top:4px;"><span style="background:var(--success); color:white; font-size:0.6rem; padding:2px 4px; border-radius:3px; font-weight:800;">âš¡ ELITE RECOVERY</span></div>`;
                } else if (metCriteriaCount > 0) {
                    tds += `<div style="margin-top:4px;"><span style="background:var(--accent-secondary); color:white; font-size:0.6rem; padding:2px 4px; border-radius:3px; font-weight:800;">âš¡ ${metCriteriaCount}/${item.dividends.length} FAST</span></div>`;
                }
            }

            tds += `</td>`;

            // Dividend Columns
            if (item.dividends && item.dividends.length > 0) {
                item.dividends.forEach(div => {
                    let content = '';

                    if (div.error) {
                        content = `<div style="color:var(--error); font-size:0.7rem; font-weight:700;">DATA ERROR</div>
                                   <div style="font-size:0.65rem; opacity:0.7;">No Price Data</div>`;
                    } else {
                        // Custom Window Recovery Stat (Only if not error)
                        let minT = parseFloat(document.getElementById('divTargetPct').value) || 0;
                        let maxT = parseFloat(document.getElementById('divMaxTargetPct').value) || 100;
                        const minC = document.getElementById('chkMin').checked;
                        const maxC = document.getElementById('chkMax').checked;

                        if (!minC || minT === 0) minT = -999999;
                        if (!maxC || maxT === 100) maxT = 999999;

                        const p = div.window_recv_pct || 0;

                        // Full Recovery Status (Restore request: Check/X above percent)
                        if (div.recovered) {
                            content += `<div style="color:var(--success); font-size:0.7rem; font-weight:700; margin-bottom:1px;">
                                            âœ… ${div.recovery_days}d
                                        </div>`;
                        } else {
                            content += `<div style="color:var(--error); font-size:0.7rem; font-weight:700; margin-bottom:1px;">
                                            âŒ ${div.recovery_days}d
                                        </div>`;
                        }

                        let pctClass = (p >= minT && p <= maxT) ? 'color:#10b981' : 'color:#94a3b8'; // Green if in range
                        content += `<div style="font-size:0.7rem; ${pctClass}">
                                      ${recWindow}d Rec: <strong>${div.window_recv_pct}%</strong>
                                    </div>`;
                    }

                    // Tooltip or extra info
                    content += `<div style="font-size:0.65rem; color:var(--text-secondary); margin-top:4px; border-top:1px solid rgba(255,255,255,0.05); padding-top:2px;">
                                  Ex: ${div.ex_date} | <strong>$${div.amount}</strong>
                                </div>`;

                    // === PRE-DIVIDEND 14-DAY INTEL ===
                    if (div.pre_div_14d) {
                        const pd = div.pre_div_14d;
                        // Strip Color Logic
                        let stripColor = 'rgba(255,255,255,0.3)';
                        if (pd.pump_detected || pd.volume_spike_detected) stripColor = '#f59e0b';
                        else if (pd.lowest_day !== null) stripColor = '#10b981';

                        let preDivContent = `<div style="font-size:0.65rem; margin-top:8px; padding-left:8px; border-left:2px solid ${stripColor};">`;

                        // Best Buy Day
                        if (pd.lowest_day !== null && pd.lowest_price !== null) {
                            preDivContent += `<div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                <span style="color:var(--text-secondary);">Best Buy:</span>
                                <span style="color:#fff;">${pd.lowest_day}d <span style="opacity:0.5;">($${pd.lowest_price})</span></span>
                            </div>`;
                        }

                        // Trend / Pump
                        const usdSign = pd.price_change_usd >= 0 ? '+' : '-';
                        const usdVal = Math.abs(pd.price_change_usd || 0);
                        let trendColor = pd.price_change_pct > 0 ? '#10b981' : (pd.price_change_pct < 0 ? '#ef4444' : '#fff');
                        let userTrendLabel = "Trend:";

                        if (pd.pump_detected) {
                            userTrendLabel = "âš  PUMP:";
                            trendColor = "#f59e0b";
                        }

                        if (pd.price_change_pct !== 0 || pd.pump_detected) {
                            preDivContent += `<div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                <span style="color:${trendColor}; opacity:0.9;">${userTrendLabel}</span>
                                <span style="color:${trendColor};">${pd.price_change_pct}% <span style="opacity:0.5;">(${usdSign}$${usdVal})</span></span>
                            </div>`;
                        }

                        // Volume Analysis
                        if (pd.avg_120d_volume > 0) {
                            function formatVol(num) {
                                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                                return num.toString();
                            }

                            let volColor = 'rgba(255,255,255,0.5)';
                            let volText = `Avg Vol: ${formatVol(pd.avg_120d_volume)}`;

                            if (pd.volume_spike_detected) {
                                volColor = '#f59e0b';
                                volText = `ðŸ”Š Vol Surge: <strong>+${pd.volume_spike_pct}%</strong>`;
                            }

                            preDivContent += `<div style="color:${volColor}; margin-top:2px; font-size:0.55rem;">
                                ${volText}
                             </div>`;
                            if (pd.volume_spike_detected) {
                                preDivContent += `<div style="color:rgba(255,255,255,0.5); font-size:0.55rem;">
                                     (vs ${formatVol(pd.avg_120d_volume)} avg)
                                  </div>`;
                            }
                        }

                        preDivContent += `</div>`;
                        content += preDivContent;
                    }

                    tds += `<td>${content}</td>`;
                });

                // Fill empty cells if this ticker has fewer divs than max
                for (let i = item.dividends.length; i < maxDivs; i++) {
                    tds += `<td><span style="color:var(--glass-border)">--</span></td>`;
                }
            } else {
                // No dividends found
                tds += `<td colspan="${maxDivs}" style="color:var(--text-secondary)">No recent dividends found</td>`;
            }

            // Stats Column
            // Format volume helper
            function formatVolume(vol) {
                if (!vol) return 'N/A';
                if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
                if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
                return vol.toString();
            }

            tds += `<td>
                        <div style="font-size:0.8rem;">
                           Price: <span style="font-weight:700;">$${item.current_price || 'N/A'}</span>
                        </div>
                        <div style="font-size:0.7rem; color:var(--text-secondary);">
                           Last Div: ${item.days_since_last_div !== null ? item.days_since_last_div + 'd ago' : 'N/A'}
                        </div>
                        ${item.next_div_days !== null ? `
                        <div style="font-size:0.7rem; color:var(--accent-primary); font-weight:700; margin-top:2px;">
                           Next Div: ${item.next_div_days}d (${item.next_ex_date})
                        </div>` : ''}
                        <div style="font-size:0.7rem; color:var(--text-secondary); margin-top:2px;">
                           Avg Vol: ${formatVolume(item.avg_volume_30d)}
                        </div>
                    </td>`;

            tds += `<td><a href="${tvUrl}" target="_blank" class="tv-btn">View</a></td>`;

            tr.innerHTML = tds;
            tbody.appendChild(tr);
        });
    }
    // MOUSE SCROLL NUMERIC CONTROL
    document.querySelectorAll('#dividendSection input[type="number"]').forEach(input => {
        input.addEventListener('wheel', function (e) {
            e.preventDefault();
            const step = parseFloat(this.step) || 1;
            const min = parseFloat(this.min);
            const max = parseFloat(this.max);
            let val = parseFloat(this.value) || 0;

            if (e.deltaY < 0) {
                val += step;
            } else {
                val -= step;
            }

            if (!isNaN(min) && val < min) val = min;
            if (!isNaN(max) && val > max) val = max;

            this.value = val;
            this.dispatchEvent(new Event('change'));
        });
    });
    function toggleInput(inputId, checkbox) {
        const input = document.getElementById(inputId);
        if (checkbox.checked) {
            input.disabled = false;
            input.parentElement.style.opacity = "1";
        } else {
            input.disabled = true;
            input.parentElement.style.opacity = "0.5";
        }
    }

    // Volume Filter Event Listener
    const volFilterEl = document.getElementById('divVolFilter');
    if (volFilterEl) {
        volFilterEl.addEventListener('change', function () {
            renderDividendResults(dataStore.dividend);
        });
    }

    // --- UI Control Panel Colors ---
    function updateControlColors() {
        const controls = [
            { cb: 'rangeMasterList', label: 'labelMasterList' },
            { cb: 'rangeCefList', label: 'labelCefList' },
            { cb: 'rangePffList', label: 'labelPffList' },
            { cb: 'imbMasterList', label: 'imbLabelMasterList' },
            { cb: 'imbCefList', label: 'imbLabelCefList' },
            { cb: 'imbPffList', label: 'imbLabelPffList' },
            { cb: 'divMasterList', label: 'divLabelMasterList' },
            { cb: 'divCefList', label: 'divLabelCefList' },
            { cb: 'divPffList', label: 'divLabelPffList' },
            { cb: 'rebMasterList', label: 'rebLabelMasterList' },
            { cb: 'rebCefList', label: 'rebLabelCefList' },
            { cb: 'rebPffList', label: 'rebLabelPffList' }
        ];
        controls.forEach(control => {
            const cb = document.getElementById(control.cb);
            const lb = document.getElementById(control.label);
            if (cb && lb) {
                if (cb.checked) {
                    lb.style.color = 'var(--success)';
                } else {
                    lb.style.color = 'var(--text-secondary)';
                }
            }
        });
    }

    // --- Rebalance Pattern Logic ---

    async function startRebalanceAnalysis() {
        const masterToggle = document.getElementById('rebMasterList');
        const cefToggle = document.getElementById('rebCefList');
        const pffToggle = document.getElementById('rebPffList');
        let tickers = [];

        if (cefToggle.checked) {
            document.getElementById('analyzeRebalanceBtn').disabled = true;
            document.getElementById('analyzeRebalanceBtn').innerText = "Loading CEF List...";
            try {
                const tRes = await fetch('/get_cef_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load CEF list: " + e.message);
                resetUI();
                return;
            }
        } else if (pffToggle.checked) {
            document.getElementById('analyzeRebalanceBtn').disabled = true;
            document.getElementById('analyzeRebalanceBtn').innerText = "Loading PFF List...";
            try {
                const tRes = await fetch('/get_pff_holdings');
                const tData = await tRes.json();
                tickers = tData.holdings ? tData.holdings.map(h => h.ticker) : [];
            } catch (e) {
                alert("Failed to load PFF list: " + e.message);
                resetUI();
                return;
            }
        } else if (masterToggle.checked) {
            document.getElementById('analyzeRebalanceBtn').disabled = true;
            document.getElementById('analyzeRebalanceBtn').innerText = "Loading Master List...";
            try {
                const tRes = await fetch('/get_tickers');
                const tData = await tRes.json();
                tickers = tData.tickers || [];
            } catch (e) {
                alert("Failed to load master list: " + e.message);
                resetUI();
                return;
            }
        } else {
            const tickersElement = document.getElementById('rebalanceTickers');
            const rawTickers = tickersElement.value;
            if (!rawTickers.trim()) {
                alert("Please enter tickers or select a list");
                return;
            }
            tickers = rawTickers.replace(/\n/g, ',').split(',').map(t => t.trim()).filter(t => t);
        }

        if (tickers.length === 0) {
            alert("No tickers to analyze.");
            resetUI();
            return;
        }

        document.getElementById('analyzeRebalanceBtn').disabled = true;
        document.getElementById('analyzeRebalanceBtn').innerText = "Analyzing Patterns...";
        document.getElementById('rebProgressContainer').style.display = 'block';
        document.getElementById('rebalanceResultsCard').style.display = 'none';
        document.querySelector('#rebalanceResultsTable tbody').innerHTML = '';
        document.getElementById('noResults').style.display = 'none';

        dataStore.rebalance = [];
        let completed = 0;
        const total = tickers.length;
        const BATCH_SIZE = 3;
        const months = document.getElementById('rebMonths').value;

        updateRebProgress(0, `Initializing rebalance scan for ${total} tickers...`);

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = tickers.slice(i, i + BATCH_SIZE);
                const batchStr = batch.join(',');

                updateRebProgress(Math.round((completed / total) * 100), `Analyzing ${batch.join(', ')}...`);

                const formData = new FormData();
                formData.append('tickers', batchStr);
                formData.append('months_back', months);

                const res = await fetch('/analyze_rebalance_batch', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    dataStore.rebalance = [...(dataStore.rebalance || []), ...data.results];
                    renderRebalanceResults(dataStore.rebalance);
                }

                completed += batch.length;
                updateRebProgress(Math.round((completed / total) * 100), `Analyzed ${completed}/${total}...`);
                await new Promise(r => setTimeout(r, 400));
            }
            updateRebProgress(100, "Scan Complete");
        } catch (e) {
            console.error(e);
            alert("Scan Error: " + e.message);
        } finally {
            resetUI();
        }
    }

    function updateRebProgress(percent, text) {
        if (!document.getElementById('rebProgressFill')) return;
        document.getElementById('rebProgressFill').style.width = percent + '%';
        document.getElementById('rebProgressPercent').innerText = percent + '%';
        document.getElementById('rebProgressText').innerText = text;
    }

    let rebalanceSortState = { column: null, direction: 'desc' };

    function sortRebalance(col) {
        if (!dataStore.rebalance || dataStore.rebalance.length === 0) return;

        if (rebalanceSortState.column === col) {
            rebalanceSortState.direction = rebalanceSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            rebalanceSortState.column = col;
            rebalanceSortState.direction = 'desc';
        }

        const dir = rebalanceSortState.direction === 'asc' ? 1 : -1;
        dataStore.rebalance.sort((a, b) => {
            let valA, valB;
            if (col === 'volume') {
                const getScore = (item) => {
                    if (!item.avg_vol_90 || item.avg_vol_90 === 0) return 0;
                    const getPoints = (val) => {
                        const diff = (val - item.avg_vol_90) / item.avg_vol_90;
                        if (diff >= 0.3) return 5;
                        if (diff >= 0.2) return 3;
                        if (diff >= 0.1) return 1;
                        return 0;
                    };
                    return getPoints(item.avg_pre_vol) +
                        getPoints(item.avg_reb_vol) +
                        getPoints(item.avg_post_vol);
                };
                valA = getScore(a);
                valB = getScore(b);
            } else {
                valA = a[col];
                valB = b[col];
            }
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA < valB) return -1 * dir;
            if (valA > valB) return 1 * dir;
            return 0;
        });

        renderRebalanceResults(dataStore.rebalance);
    }

    function renderRebalanceResults(results) {
        if (!results || results.length === 0) return;
        document.getElementById('rebalanceResultsCard').style.display = 'block';
        document.getElementById('rebMatchCount').innerText = `${results.length} Symbols Analyzed`;
        const tbody = document.querySelector('#rebalanceResultsTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        results.forEach(item => {
            const tr = document.createElement('tr');
            const tvUrl = `https://www.tradingview.com/chart/?symbol=${item.tv_symbol}`;

            const preColor = item.avg_pre_3_diff > 0 ? 'var(--success)' : (item.avg_pre_3_diff < 0 ? 'var(--error)' : 'white');
            const postColor = item.avg_post_3_diff > 0 ? 'var(--success)' : (item.avg_post_3_diff < 0 ? 'var(--error)' : 'white');
            const rebaColor = item.avg_reba_body_diff > 0 ? 'var(--success)' : (item.avg_reba_body_diff < 0 ? 'var(--error)' : 'white');

            const getConsistencyHtml = (field, pos, neg, total) => {
                const count = pos > neg ? pos : neg;
                const direction = pos > neg ? 'Up' : 'Down';
                const color = pos > neg ? 'var(--success)' : (neg > pos ? 'var(--error)' : 'var(--text-secondary)');
                const pct = Math.round((count / total) * 100);
                return `
                    <div style="font-size:0.65rem; margin-top:4px; display:flex; flex-direction:column; gap:2px;">
                        <div style="display:flex; justify-content:space-between; opacity:0.8;">
                            <span>Consistency:</span>
                            <span style="color:${color}; font-weight:800;">${count}/${total} ${direction} (${pct}%)</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; opacity:0.6;">
                            <span>Range:</span>
                            <span>[${item[field + '_min']}$, ${item[field + '_max']}$]</span>
                        </div>
                    </div>
                `;
            };

            // Find Dividend Info
            let divInfo = null;
            if (item.details && item.details.length > 0) {
                const evWithDiv = item.details.find(ev => ev.dividends && ev.dividends.length > 0);
                if (evWithDiv && evWithDiv.dividends.length > 0) {
                    divInfo = evWithDiv.dividends[0];
                }
            }

            // Volume Coloring Logic
            const baseVal = item.avg_vol_90;
            const getVolStyle = (val) => {
                if (!baseVal || baseVal === 0) return 'opacity:1;';
                const diff = (val - baseVal) / baseVal;
                if (diff >= 0.3) return 'color:#ef4444; font-weight:700;'; // Red
                if (diff >= 0.2) return 'color:#f59e0b; font-weight:700;'; // Orange
                if (diff >= 0.1) return 'color:#fbbf24; font-weight:700;'; // Yellow
                return 'opacity:0.8;';
            };

            const vol90 = formatDetailedVol(item.avg_vol_90);
            const volPre = formatDetailedVol(item.avg_pre_vol);
            const volReb = formatDetailedVol(item.avg_reb_vol);
            const volPost = formatDetailedVol(item.avg_post_vol);

            let divSegment = '';
            if (divInfo) {
                const divVol = formatDetailedVol(divInfo.volume);
                divSegment = `
                    <span style="opacity:0.2;">|</span>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-size:0.5rem; color:#a855f7; opacity:0.8; font-weight:800; text-transform:uppercase; margin-bottom:2px;">div</span>
                        <span title="Ex-Div Date: ${divInfo.date} (Amount: $${divInfo.amount})" style="color:#a855f7; font-weight:700;">${divVol}</span>
                    </div>
                `;
            }

            tr.innerHTML = `
                <td>
                    <div style="display:flex; align-items:center;">
                        <span class="ticker-name">${item.ticker}</span>
                        <span style="font-size:0.6rem; opacity:0.5; margin-left:8px;">${item.sample_size} events</span>
                    </div>
                </td>
                <td style="vertical-align: top; padding-top: 1rem;">
                    <div style="color:${preColor}; font-weight:700;">${item.avg_pre_3_diff > 0 ? '+' : ''}${item.avg_pre_3_diff}$</div>
                    ${getConsistencyHtml('pre_3', item.pre_3_pos, item.pre_3_neg, item.sample_size)}
                </td>
                <td style="vertical-align: top; padding-top: 1rem;">
                    <div style="font-weight:700; white-space:nowrap;">
                        <span style="color:${item.reba_dominant_color === 'Green' ? 'var(--success)' : 'var(--error)'};">
                            ${item.avg_reba_body_diff > 0 ? '+' : ''}${item.avg_reba_body_diff}$ ${item.reba_dominant_color === 'Green' ? 'â†‘' : 'â†“'}
                        </span>
                        <span style="font-size:0.75rem; color:var(--text-secondary); opacity:0.6; margin-left:6px; font-weight:400;">
                            ${item.avg_reba_range_diff}$
                        </span>
                    </div>
                    ${getConsistencyHtml('reba_body', item.reba_body_pos, item.reba_body_neg, item.sample_size)}
                </td>
                <td style="vertical-align: top; padding-top: 1rem;">
                    <div style="color:${postColor}; font-weight:700;">${item.avg_post_3_diff > 0 ? '+' : ''}${item.avg_post_3_diff}$</div>
                    ${getConsistencyHtml('post_3', item.post_3_pos, item.post_3_neg, item.sample_size)}
                </td>
                <td style="vertical-align: top; padding-top: 1rem; font-size: 0.85rem;">
                    <div style="font-weight:700; color:var(--text-secondary); opacity:0.6; font-size:0.75rem;">${item.pre_3_std}$</div>
                    <div style="font-weight:800; color:var(--text-primary); margin-top:2px;">${item.pre_3_std_pct}%</div>
                </td>
                <td style="vertical-align: top; padding-top: 1rem; font-size: 0.85rem;">
                    <div style="font-weight:700; color:var(--text-secondary); opacity:0.6; font-size:0.75rem;">${item.reba_body_std}$</div>
                    <div style="font-weight:800; color:var(--text-primary); margin-top:2px;">${item.reba_body_std_pct}%</div>
                </td>
                <td style="vertical-align: top; padding-top: 1rem; font-size: 0.85rem;">
                    <div style="font-weight:700; color:var(--text-secondary); opacity:0.6; font-size:0.75rem;">${item.post_3_std}$</div>
                    <div style="font-weight:800; color:var(--text-primary); margin-top:2px;">${item.post_3_std_pct}%</div>
                </td>
                <td style="vertical-align: top; padding-top: 1rem;">
                    <div style="font-size:0.75rem; white-space:nowrap; display:flex; gap:8px; align-items:flex-end;">
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <span style="font-size:0.5rem; color:var(--text-secondary); opacity:0.5; font-weight:800; text-transform:uppercase; margin-bottom:2px;">avg</span>
                            <span title="90d Avg Baseline" style="opacity:0.5;">${vol90}</span>
                        </div>
                        <span style="opacity:0.2;">|</span>
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <span style="font-size:0.5rem; color:var(--text-secondary); opacity:0.5; font-weight:800; text-transform:uppercase; margin-bottom:2px;">pre</span>
                            <span title="Pre-3 Avg" style="${getVolStyle(item.avg_pre_vol)}">${volPre}</span>
                        </div>
                        <span style="opacity:0.2;">|</span>
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <span style="font-size:0.5rem; color:var(--text-secondary); opacity:0.5; font-weight:800; text-transform:uppercase; margin-bottom:2px;">reb</span>
                            <span title="Rebalance Day" style="${getVolStyle(item.avg_reb_vol)}">${volReb}</span>
                        </div>
                        <span style="opacity:0.2;">|</span>
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <span style="font-size:0.5rem; color:var(--text-secondary); opacity:0.5; font-weight:800; text-transform:uppercase; margin-bottom:2px;">post</span>
                            <span title="Post-3 Avg" style="${getVolStyle(item.avg_post_vol)}">${volPost}</span>
                        </div>
                        ${divSegment}
                    </div>
                </td>
                <td>
                    <a href="${tvUrl}" target="_blank" class="tv-btn">View Chart</a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function formatDetailedVol(val) {
        if (!val) return '0';
        if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
        if (val >= 1000) return (val / 1000).toFixed(1) + 'K';
        return Math.round(val).toString();
    }

    // --- Master List Management ---
    function openMasterListModal() {
        document.getElementById('masterListModal').style.display = 'flex';
        loadMasterListInModal();
    }

    function closeMasterListModal() {
        document.getElementById('masterListModal').style.display = 'none';
        document.getElementById('newMasterTicker').value = '';
    }

    let masterListRawData = [];
    let masterListData = [];
    let masterListSelectedSectors = new Set();

    async function loadMasterListInModal() {
        const container = document.getElementById('masterListContainer');
        const countSpan = document.getElementById('masterListCount');

        container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; grid-column:1/-1; padding:2rem;">Loading...</div>';

        try {
            const res = await fetch('/get_master_list_tickers');
            const data = await res.json();

            if (data.tickers && data.tickers.length > 0) {
                masterListRawData = data.tickers;

                // Initialize Sector Filter UI (renders based on masterListSelectedSectors)
                renderMasterSectorFilter();

                // Apply existing filters instead of showing all
                applyMasterListFilter();
            } else {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; grid-column:1/-1; padding:2rem;">No tickers in Master List</div>';
                countSpan.innerText = '0';
            }
        } catch (e) {
            container.innerHTML = `<div style="color:var(--error); text-align:center; grid-column:1/-1; padding:2rem;">Error: ${e.message}</div>`;
        }
    }

    function renderMasterSectorFilter() {
        const filterContainer = document.getElementById('masterSectorFilter');
        if (!filterContainer) return;

        const sectors = [...new Set(masterListRawData.map(t => t.sector))].sort();
        filterContainer.innerHTML = '';

        // Create vertical checkbox list
        sectors.forEach(sector => {
            const label = document.createElement('label');
            label.className = 'sector-checkbox-item';
            if (masterListSelectedSectors.has(sector)) {
                label.classList.add('active');
            }

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = masterListSelectedSectors.has(sector);
            cb.onchange = () => {
                if (cb.checked) {
                    masterListSelectedSectors.add(sector);
                    label.classList.add('active');
                } else {
                    masterListSelectedSectors.delete(sector);
                    label.classList.remove('active');
                }
                applyMasterListFilter();
            };

            label.appendChild(cb);
            label.appendChild(document.createTextNode(sector));
            filterContainer.appendChild(label);
        });
    }

    function masterSelectAllSectors() {
        const sectors = [...new Set(masterListRawData.map(t => t.sector))];
        sectors.forEach(s => masterListSelectedSectors.add(s));
        renderMasterSectorFilter();
        applyMasterListFilter();
    }

    function masterClearSectors() {
        masterListSelectedSectors.clear();
        renderMasterSectorFilter();
        applyMasterListFilter();
    }

    function applyMasterListFilter() {
        if (masterListSelectedSectors.size === 0) {
            masterListData = [...masterListRawData];
        } else {
            masterListData = masterListRawData.filter(t => masterListSelectedSectors.has(t.sector));
        }
        renderMasterList();
    }

    function renderMasterList() {
        const container = document.getElementById('masterListContainer');
        const countSpan = document.getElementById('masterListCount');
        const showingSpan = document.getElementById('masterListShowing');

        container.innerHTML = '';
        countSpan.innerText = masterListRawData.length;
        if (showingSpan) showingSpan.innerText = masterListData.length;

        masterListData.forEach(item => {
            const ticker = item.ticker;
            const sector = item.sector;
            const div = document.createElement('div');
            div.style.background = 'rgba(255,255,255,0.05)';
            div.style.border = '1px solid var(--glass-border)';
            div.style.borderRadius = '4px';
            div.style.padding = '0.5rem 0.6rem';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';
            div.style.fontSize = '0.8rem';

            div.innerHTML = `
                <div>
                    <div style="font-weight:800; color:white;">${ticker}</div>
                    <div style="font-size:0.65rem; color:var(--text-secondary);">${sector}</div>
                </div>
                <button onclick="deleteMasterListTicker('${ticker}')" style="background:transparent; border:none; color:var(--error); cursor:pointer; font-weight:bold; font-size:1rem; line-height:1;">&times;</button>
            `;
            container.appendChild(div);
        });
    }

    async function addMasterListTicker() {
        const input = document.getElementById('newMasterTicker');
        const ticker = input.value.trim();

        if (!ticker) return;

        try {
            const formData = new FormData();
            formData.append('ticker', ticker);

            const res = await fetch('/add_master_list_ticker', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                input.value = '';
                loadMasterListInModal();
            } else {
                alert(data.message || 'Failed to add ticker');
            }
        } catch (e) {
            alert('Error adding ticker: ' + e.message);
        }
    }

    async function deleteMasterListTicker(ticker) {
        if (!confirm(`Remove ${ticker} from Master List?`)) return;

        try {
            const formData = new FormData();
            formData.append('ticker', ticker);

            const res = await fetch('/delete_master_list_ticker', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                loadMasterListInModal();
            } else {
                alert(data.message || 'Failed to delete ticker');
            }
        } catch (e) {
            alert('Error deleting ticker: ' + e.message);
        }
    }

    // --- CEF List Management ---
    function openCEFListModal() {
        document.getElementById('cefListModal').style.display = 'flex';
        loadCEFListInModal();
    }

    function closeCEFListModal() {
        document.getElementById('cefListModal').style.display = 'none';
        document.getElementById('newCEFTicker').value = '';
    }

    async function loadCEFListInModal() {
        const container = document.getElementById('cefListContainer');
        const countSpan = document.getElementById('cefListCount');

        container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; grid-column:1/-1; padding:2rem;">Loading...</div>';

        try {
            const res = await fetch('/get_cef_list_tickers');
            const data = await res.json();

            if (data.tickers && data.tickers.length > 0) {
                container.innerHTML = '';
                countSpan.innerText = data.tickers.length;

                data.tickers.forEach(ticker => {
                    const item = document.createElement('div');
                    item.style.background = 'rgba(255,255,255,0.05)';
                    item.style.border = '1px solid var(--glass-border)';
                    item.style.borderRadius = '4px';
                    item.style.padding = '0.5rem';
                    item.style.display = 'flex';
                    item.style.justifyContent = 'space-between';
                    item.style.alignItems = 'center';
                    item.style.fontSize = '0.85rem';
                    item.style.fontWeight = '700';
                    item.style.color = 'white';

                    item.innerHTML = `
                        <span>${ticker}</span>
                        <button onclick="deleteCEFListTicker('${ticker}')" style="background:transparent; border:none; color:var(--error); cursor:pointer; font-weight:bold; font-size:1.2rem; line-height:1;">&times;</button>
                    `;
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; grid-column:1/-1; padding:2rem;">No tickers in CEF List</div>';
                countSpan.innerText = '0';
            }
        } catch (e) {
            container.innerHTML = `<div style="color:var(--error); text-align:center; grid-column:1/-1; padding:2rem;">Error: ${e.message}</div>`;
        }
    }

    async function addCEFListTicker() {
        const input = document.getElementById('newCEFTicker');
        const ticker = input.value.trim();

        if (!ticker) return;

        try {
            const formData = new FormData();
            formData.append('ticker', ticker);

            const res = await fetch('/add_cef_list_ticker', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                input.value = '';
                loadCEFListInModal();
            } else {
                alert(data.message || 'Failed to add ticker');
            }
        } catch (e) {
            alert('Error adding ticker: ' + e.message);
        }
    }

    async function deleteCEFListTicker(ticker) {
        if (!confirm(`Remove ${ticker} from CEF List?`)) return;

        try {
            const formData = new FormData();
            formData.append('ticker', ticker);

            const res = await fetch('/delete_cef_list_ticker', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                loadCEFListInModal();
            } else {
                alert(data.message || 'Failed to delete ticker');
            }
        } catch (e) {
            alert('Error deleting ticker: ' + e.message);
        }
    }

    // --- PFF Holdings List ---
    let pffRawData = [];
    let pffData = [];
    let pffSortState = { column: 'weight', direction: 'desc' };
    let pffSelectedSectors = new Set();

    function openPFFModal() {
        document.getElementById('pffListModal').style.display = 'flex';
        document.getElementById('pffSearchInput').value = '';
        loadPFFListInModal();
    }

    function closePFFModal() {
        document.getElementById('pffListModal').style.display = 'none';
    }

    async function loadPFFListInModal() {
        const container = document.getElementById('pffListContainer');
        container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:2rem;">Loading holdings...</div>';

        try {
            const res = await fetch('/get_pff_holdings');
            const data = await res.json();

            if (data.holdings && data.holdings.length > 0) {
                pffRawData = data.holdings;
                pffData = [...pffRawData];

                // Initialize PFF Sector Filter
                renderPFFSectorFilter();

                // Default sort: Weight descending
                pffSortState = { column: 'weight', direction: 'desc' };
                applyPFFSort();
            } else {
                container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:2rem;">No holdings found or file missing.</div>';
                document.getElementById('pffListCount').innerText = '0';
            }
        } catch (e) {
            container.innerHTML = `<div style="color:var(--error); text-align:center; padding:2rem;">Error: ${e.message}</div>`;
        }
    }

    function sortPFFData(column) {
        if (pffSortState.column === column) {
            pffSortState.direction = pffSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            pffSortState.column = column;
            pffSortState.direction = 'asc';
        }
        applyPFFSort();
    }

    function applyPFFSort() {
        const col = pffSortState.column;
        const dir = pffSortState.direction === 'asc' ? 1 : -1;

        // Update UI Sort Icons
        document.querySelectorAll('.pff-header-cell').forEach(cell => cell.classList.remove('active-sort'));
        const activeCell = document.querySelector(`.pff-header-cell[onclick*="${col}"]`);
        if (activeCell) {
            activeCell.classList.add('active-sort');
            const icon = activeCell.querySelector('.sort-icon');
            if (icon) icon.innerText = pffSortState.direction === 'asc' ? ' â–²' : ' â–¼';
        }

        renderPFFList();
    }

    function renderPFFSectorFilter() {
        const filterContainer = document.getElementById('pffSectorFilter');
        if (!filterContainer) return;

        const sectors = [...new Set(pffRawData.map(t => t.sector))].sort();
        filterContainer.innerHTML = '';

        // Create vertical checkbox list
        sectors.forEach(sector => {
            const label = document.createElement('label');
            label.className = 'sector-checkbox-item';
            if (pffSelectedSectors.has(sector)) {
                label.classList.add('active');
            }

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = pffSelectedSectors.has(sector);
            cb.onchange = () => {
                if (cb.checked) {
                    pffSelectedSectors.add(sector);
                    label.classList.add('active');
                } else {
                    pffSelectedSectors.delete(sector);
                    label.classList.remove('active');
                }
                renderPFFList();
            };

            label.appendChild(cb);
            label.appendChild(document.createTextNode(sector));
            filterContainer.appendChild(label);
        });
    }

    function pffSelectAllSectors() {
        const sectors = [...new Set(pffRawData.map(t => t.sector))];
        sectors.forEach(s => pffSelectedSectors.add(s));
        renderPFFSectorFilter();
        renderPFFList();
    }

    function pffClearSectors() {
        pffSelectedSectors.clear();
        renderPFFSectorFilter();
        renderPFFList();
    }

    function renderPFFList() {
        const container = document.getElementById('pffListContainer');
        const countSpan = document.getElementById('pffListCount');
        const showingText = document.getElementById('pffShowingText');

        container.innerHTML = '';
        countSpan.innerText = pffRawData.length;

        // Apply filters (Search + Sector)
        const searchQuery = document.getElementById('pffSearchInput').value.trim().toUpperCase();
        let filtered = pffRawData.filter(item => {
            const matchesSearch = !searchQuery ||
                (item.ticker && item.ticker.toUpperCase().includes(searchQuery)) ||
                (item.name && item.name.toUpperCase().includes(searchQuery));
            const matchesSector = pffSelectedSectors.size === 0 || pffSelectedSectors.has(item.sector);
            return matchesSearch && matchesSector;
        });

        // Apply current sort to filtered data
        const col = pffSortState.column;
        const dir = pffSortState.direction === 'asc' ? 1 : -1;
        filtered.sort((a, b) => {
            let valA = a[col];
            let valB = b[col];
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();
            if (valA < valB) return -1 * dir;
            if (valA > valB) return 1 * dir;
            return 0;
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:2rem;">No matching tickers found.</div>';
            showingText.innerText = `Matched 0 of ${pffRawData.length} holdings`;
            return;
        }

        showingText.innerText = `Showing ${filtered.length} of ${pffRawData.length} holdings`;

        filtered.forEach(item => {
            const row = document.createElement('div');
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '90px 1fr 120px 80px 80px 70px 90px';
            row.style.gap = '1rem';
            row.style.padding = '0.7rem 1rem';
            row.style.borderBottom = '1px solid var(--glass-border)';
            row.style.fontSize = '0.85rem';
            row.style.color = 'white';
            row.style.alignItems = 'center';

            const priceDisplay = item.price ? `$${item.price.toFixed(2)}` : '-';
            const weightClass = item.weight > 1.0 ? 'var(--success)' : 'white';
            const weightDisplay = `<span style="color:${weightClass}; font-weight:700;">${item.weight.toFixed(2)}%</span>`;

            const qtyDisplay = item.quantity ?
                new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(item.quantity) : '-';

            const mvDisplay = item.market_value ?
                new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: "compact", maximumFractionDigits: 1 }).format(item.market_value) : '-';

            row.innerHTML = `
                <div style="font-weight:800; color:var(--accent-primary);">${item.ticker}</div>
                <div style="color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${item.name}">${item.name}</div>
                <div style="color:var(--text-secondary); font-size:0.75rem;">${item.sector || 'Other'}</div>
                <div style="text-align:right; font-family:'Outfit'; color:var(--text-secondary); font-weight:600;">${priceDisplay}</div>
                <div style="text-align:right; font-family:'Outfit'; color:var(--text-secondary);">${qtyDisplay}</div>
                <div style="text-align:right; font-family:'Outfit';">${weightDisplay}</div>
                <div style="text-align:right; font-family:'Outfit'; color:var(--text-secondary); font-size:0.8rem;">${mvDisplay}</div>
            `;
            container.appendChild(row);
        });
    }

    // Initialize UI
    document.addEventListener('DOMContentLoaded', () => {
        updateControlColors();
        // Initialize Toggle States
        toggleInput('imbMaxWick', document.getElementById('imbFilterWick'));
        toggleInput('imbMinProfit', document.getElementById('imbFilterProfit'));
    });

    function toggleInput(inputId, checkbox) {
        const input = document.getElementById(inputId);
        if (!input) return;

        if (checkbox.checked) {
            input.disabled = false;
            input.style.opacity = '1';
        } else {
            input.disabled = true;
            input.style.opacity = '0.5';
        }
    }
</script>

<!-- CEF List Management Modal -->
<div id="cefListModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; backdrop-filter:blur(5px); align-items:center; justify-content:center;">
    <div class="glass-card"
        style="width:90%; max-width:600px; max-height:85vh; display:flex; flex-direction:column; padding:2rem; margin:0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.5rem;">Manage CEF List</h2>
            <button onclick="closeCEFListModal()"
                style="background:transparent; border:none; color:var(--text-secondary); cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>

        <div class="input-group" style="margin-bottom:1rem;">
            <div style="display:flex; gap:0.5rem;">
                <input type="text" id="newCEFTicker" placeholder="TICKER"
                    style="flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:white; padding:0.8rem; border-radius:4px; font-weight:700; text-transform:uppercase;">
                <button onclick="addCEFListTicker()" class="btn-primary"
                    style="padding:0.8rem 1.5rem; width:auto;">ADD</button>
            </div>
        </div>

        <div id="cefListContainer"
            style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:8px; padding:1rem; display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:0.8rem; align-content:start;">
            <!-- Tickers will be loaded here -->
            <div style="color:var(--text-secondary); text-align:center; grid-column:1/-1; padding:2rem;">Loading...
            </div>
        </div>

        <div style="margin-top:1rem; text-align:right; font-size:0.8rem; color:var(--text-secondary);">
            Total: <span id="cefListCount">0</span> tickers
        </div>
    </div>
</div>
<div id="masterListModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; backdrop-filter:blur(5px); align-items:center; justify-content:center;">
    <div class="glass-card"
        style="width:95%; max-width:900px; max-height:90vh; display:flex; flex-direction:column; padding:0; margin:0; overflow:hidden;">

        <!-- Header -->
        <div
            style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--glass-border);">
            <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.5rem;">Manage Master List</h2>
            <button onclick="closeMasterListModal()"
                style="background:transparent; border:none; color:var(--text-secondary); cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>

        <!-- Add Ticker Row -->
        <div style="padding:1rem 2rem; border-bottom:1px solid var(--glass-border); background:rgba(0,0,0,0.2);">
            <div style="display:flex; gap:0.5rem;">
                <input type="text" id="newMasterTicker" placeholder="TICKER"
                    style="flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:white; padding:0.8rem; border-radius:4px; font-weight:700; text-transform:uppercase;">
                <button onclick="addMasterListTicker()" class="btn-primary"
                    style="padding:0.8rem 1.5rem; width:auto;">ADD</button>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div style="display:flex; flex:1; overflow:hidden;">

            <!-- Left Sidebar: Sector Filters -->
            <div
                style="width:180px; min-width:180px; border-right:1px solid var(--glass-border); background:rgba(0,0,0,0.3); display:flex; flex-direction:column;">
                <div style="padding:1rem; border-bottom:1px solid var(--glass-border);">
                    <div
                        style="font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-secondary); margin-bottom:0.8rem;">
                        Filter by Sector</div>
                    <div style="display:flex; flex-direction:column; gap:0.4rem;">
                        <button onclick="masterSelectAllSectors()" class="sidebar-btn">Select All</button>
                        <button onclick="masterClearSectors()" class="sidebar-btn secondary">Clear Selection</button>
                    </div>
                </div>
                <div id="masterSectorFilter" style="flex:1; overflow-y:auto; padding:0.8rem;">
                    <!-- Sector checkboxes will be loaded here -->
                </div>
            </div>

            <!-- Right Side: Ticker Grid -->
            <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                <div id="masterListContainer"
                    style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.2); padding:1rem; display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:0.6rem; align-content:start;">
                    <!-- Tickers will be loaded here -->
                    <div style="color:var(--text-secondary); text-align:center; grid-column:1/-1; padding:2rem;">
                        Loading...</div>
                </div>
                <div
                    style="padding:1rem 1.5rem; text-align:right; font-size:0.8rem; color:var(--text-secondary); border-top:1px solid var(--glass-border);">
                    Showing: <span id="masterListShowing">0</span> / Total: <span id="masterListCount">0</span> tickers
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PFF Holdings View Modal -->
<div id="pffListModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; backdrop-filter:blur(5px); align-items:center; justify-content:center;">
    <div class="glass-card"
        style="width:95%; max-width:1100px; max-height:90vh; display:flex; flex-direction:column; padding:0; margin:0; overflow:hidden;">

        <!-- Header -->
        <div
            style="display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem; border-bottom:1px solid var(--glass-border);">
            <div>
                <h2 style="margin:0; font-family:'Outfit'; font-weight:800; font-size:1.5rem;">PFF ETF Holdings</h2>
                <div style="font-size:0.75rem; color:var(--text-secondary); margin-top:0.25rem;">
                    ANALYZED PREFERRED STOCKS | <span id="pffListCount">0</span> HOLDINGS
                </div>
            </div>
            <div style="display:flex; gap:1rem; align-items:center;">
                <!-- SEARCH BOX -->
                <div style="position:relative;">
                    <input type="text" id="pffSearchInput" placeholder="SEARCH TICKER"
                        oninput="filterPFFList(this.value)"
                        style="background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:white; padding:0.6rem 1rem 0.6rem 2.2rem; border-radius:4px; font-weight:700; width:200px; font-size:0.8rem;">
                    <svg style="position:absolute; left:0.8rem; top:50%; transform:translateY(-50%); opacity:0.5;"
                        width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <button onclick="closePFFModal()"
                    style="background:transparent; border:none; color:var(--text-secondary); cursor:pointer; font-size:1.5rem;">&times;</button>
            </div>
        </div>

        <style>
            .pff-header-cell {
                cursor: pointer;
                user-select: none;
                display: flex;
                align-items: center;
                gap: 4px;
                transition: color 0.2s;
            }

            .pff-header-cell:hover {
                color: var(--accent-primary);
            }

            .sort-icon {
                font-size: 0.7rem;
                opacity: 0.3;
            }

            .pff-header-cell.active-sort {
                color: var(--accent-primary);
            }

            .pff-header-cell.active-sort .sort-icon {
                opacity: 1;
            }
        </style>

        <!-- Two Column Layout -->
        <div style="display:flex; flex:1; overflow:hidden;">

            <!-- Left Sidebar: Sector Filters -->
            <div
                style="width:180px; min-width:180px; border-right:1px solid var(--glass-border); background:rgba(0,0,0,0.3); display:flex; flex-direction:column;">
                <div style="padding:1rem; border-bottom:1px solid var(--glass-border);">
                    <div
                        style="font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-secondary); margin-bottom:0.8rem;">
                        Filter by Sector</div>
                    <div style="display:flex; flex-direction:column; gap:0.4rem;">
                        <button onclick="pffSelectAllSectors()" class="sidebar-btn">Select All</button>
                        <button onclick="pffClearSectors()" class="sidebar-btn secondary">Clear Selection</button>
                    </div>
                </div>
                <div id="pffSectorFilter" style="flex:1; overflow-y:auto; padding:0.8rem;">
                    <!-- Sector checkboxes will be loaded here -->
                </div>
            </div>

            <!-- Right Side: Holdings Table -->
            <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                <!-- Header Row -->
                <div id="pffHeaderRow"
                    style="display:grid; grid-template-columns: 80px 1fr 90px 70px 70px 60px 80px; gap:0.8rem; padding:0.8rem 1rem; background:rgba(255,255,255,0.05); font-weight:800; font-size:0.7rem; color:var(--text-secondary); letter-spacing:1px; text-transform:uppercase;">
                    <div class="pff-header-cell" onclick="sortPFFData('ticker')">TICKER <span
                            class="sort-icon">â–²â–¼</span></div>
                    <div class="pff-header-cell" onclick="sortPFFData('name')">NAME <span class="sort-icon">â–²â–¼</span>
                    </div>
                    <div class="pff-header-cell" onclick="sortPFFData('sector')">SECTOR <span
                            class="sort-icon">â–²â–¼</span></div>
                    <div class="pff-header-cell" style="justify-content:flex-end;" onclick="sortPFFData('price')">PRICE
                        <span class="sort-icon">â–²â–¼</span>
                    </div>
                    <div class="pff-header-cell" style="justify-content:flex-end;" onclick="sortPFFData('quantity')">QTY
                        <span class="sort-icon">â–²â–¼</span>
                    </div>
                    <div class="pff-header-cell" style="justify-content:flex-end;" onclick="sortPFFData('weight')">WGT%
                        <span class="sort-icon">â–²â–¼</span>
                    </div>
                    <div class="pff-header-cell" style="justify-content:flex-end;"
                        onclick="sortPFFData('market_value')">MKT VAL <span class="sort-icon">â–²â–¼</span></div>
                </div>

                <div id="pffListContainer"
                    style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.2); padding:0.5rem; scrollbar-width: thin; scrollbar-color: var(--glass-border) transparent;">
                    <!-- Holdings will be loaded here -->
                    <div style="color:var(--text-secondary); text-align:center; padding:2rem;">Loading holdings...</div>
                </div>

                <div
                    style="padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center; font-size:0.75rem; color:var(--text-secondary); border-top:1px solid var(--glass-border);">
                    <div id="pffShowingText">Showing all holdings</div>
                    <div style="font-weight:700;">@ORHANWOLDE SYSTEM TERMINAL</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="signature">@ORHANWOLDE</div>

</body>

</html>